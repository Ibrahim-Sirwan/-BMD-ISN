<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="documentTitle">Business Management Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons for vector icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js CDN for interactive data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- flatpickr for date pickers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable for structured PDF table generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS (xlsx.js) for Excel generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Base styles for the body, setting font and background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure body takes full viewport height */
            color: #333; /* Default text color */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text color */
        }
        body.dark-mode .bg-white {
            background-color: #2d3748; /* Darker card background */
        }
        body.dark-mode .text-gray-800 {
            color: #e2e8f0;
        }
        body.dark-mode .text-gray-700 {
            color: #cbd5e0;
        }
        body.dark-mode .text-gray-600 {
            color: #a0aec0;
        }
        body.dark-mode .text-gray-500 {
            color: #718096;
        }
        body.dark-mode .border-gray-200 {
            border-color: #4a5568;
        }
        body.dark-mode .shadow-xl {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .bg-gray-50 {
            background-color: #2d3748;
        }
        body.dark-mode .bg-gray-100 {
            background-color: #4a5568;
        }
        body.dark-mode .divide-gray-200 {
            border-color: #4a5568;
        }
        body.dark-mode .border-gray-300 {
            border-color: #4a5568;
        }
        body.dark-mode input, body.dark-mode textarea, body.dark-mode select {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        body.dark-mode input:focus, body.dark-mode textarea:focus, body.dark-mode select:focus {
            border-color: #63b3ed; /* blue-300 for focus */
            box-shadow: 0 0 0 1px #63b3ed;
        }
        body.dark-mode input[disabled], body.dark-mode select[disabled] {
            background-color: #3b4556; /* Slightly lighter than background for disabled */
            cursor: not-allowed;
            opacity: 0.7;
        }
        body.dark-mode .autocomplete-items {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        body.dark-mode .autocomplete-items div {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode .autocomplete-items div:hover {
            background-color: #4a5568;
        }
        body.dark-mode .autocomplete-active {
            background-color: #3B82F6 !important; /* blue-500 */
            color: #ffffff !important;
        }
        body.dark-mode .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        body.dark-mode .close-button {
            color: #a0aec0;
        }
        body.dark-mode .close-button:hover,
        body.dark-mode .close-button:focus {
            color: #e2e8f0;
        }
        body.dark-mode .qr-code-display {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        /* Custom scrollbar for a cleaner look across browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        body.dark-mode ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        body.dark-mode ::-webkit-scrollbar-thumb {
            background: #6b7280;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            cursor: pointer;
        }
        body.dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #4a5568;
        }

        /* Styling for the active tab button */
        .tab-button.active {
            border-color: #3B82F6; /* blue-500 */
            color: #3B82F6; /* blue-500 */
            background-color: #EBF8FF; /* blue-50 */
        }
        body.dark-mode .tab-button.active {
            background-color: #1f2937; /* A darker blue-like shade for dark mode */
            color: #63B3ED; /* blue-300 */
            border-color: #63B3ED;
        }
        /* Hiding inactive tab content sections */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* RTL (Right-to-Left) adjustments for Arabic and Kurdish languages */
        [data-lang="ar"] body, [data-lang="ku"] body {
            direction: rtl; /* Sets text direction to RTL */
            text-align: right; /* Aligns general text to the right */
        }
        /* Adjusting flex item justification for RTL forms/buttons */
        [data-lang="ar"] .flex.justify-end, [data-lang="ku"] .flex.justify-end {
            justify-content: flex-start;
        }
        [data-lang="ar"] .flex.justify-start, [data-lang="ku"] .flex.justify-start {
            justify-content: flex-end;
        }
        /* Reversing order of flex items for RTL layouts where needed */
        [data-lang="ar"] .flex.justify-between, [data-lang="ku"] .flex.justify-between {
            flex-direction: row-reverse;
        }
        /* Ensuring input placeholders align correctly in RTL */
        [data-lang="ar"] input::placeholder, [data-lang="ku"] input::placeholder {
            text-align: right;
        }
        [data-lang="ar"] .text-left, [data-lang="ku"] .text-left {
            text-align: right;
        }
        [data-lang="ar"] .text-right, [data-lang="ku"] .text-right {
            text-align: left;
        }
        /* Table header/cell alignment for RTL */
        [data-lang="ar"] .table th, [data-lang="ku"] .table th {
            text-align: right;
        }
        [data-lang="ar"] .table td, [data-lang="ku"] .table td {
            text-align: right;
        }
        /* Exceptions for specific table columns that should remain LTR (e.g., barcode, currency values) */
        [data-lang="ar"] .table .text-left-ltr, [data-lang="ku"] .table .text-left-ltr {
            text-align: left;
            direction: ltr;
        }
        [data-lang="ar"] .table .text-right-ltr, [data-lang="ku"] .table .text-right-ltr {
            text-align: right;
            direction: ltr;
        }


        /* Specific styling for the simulated QR code display */
        .qr-code-display {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            font-family: 'Courier New', Courier, monospace; /* Monospace font for code/data */
            font-size: 0.8em;
            color: #333;
            word-break: break-all; /* Ensures long strings wrap */
            white-space: normal;
            line-height: 1.2;
            margin-top: 5px;
            text-align: left; /* Keep QR data LTR regardless of page direction */
            direction: ltr; /* Explicitly set LTR for technical display */
        }
        /* Overriding RTL for QR code display in specific language contexts */
        [data-lang="ar"] .qr-code-display, [data-lang="ku"] .qr-code-display {
            text-align: left;
            direction: ltr;
        }

        /* Modal overlay: covers the screen and centers the modal content */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black background */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Ensures modal is on top of other content */
        }
        /* Modal content box styling */
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            max-width: 90%;
            width: 500px; /* Fixed width, adjusted for responsiveness */
            max-height: 90vh; /* Limits height, preventing overflow */
            overflow-y: auto; /* Enables vertical scrolling if content exceeds height */
            position: relative; /* Allows absolute positioning of child elements (e.g., close button) */
            animation: fadeIn 0.3s ease-out; /* Fade-in animation for modal appearance */
        }
        /* Close button for modals */
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        /* Adjust close button position for RTL */
        [data-lang="ar"] .close-button, [data-lang="ku"] .close-button {
            right: auto;
            left: 15px;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        /* Fade-in animation definition */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Styles for the autocomplete dropdown suggestions */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99; /* Ensures items appear above other elements */
            top: 100%; /* Positions dropdown directly below the input */
            left: 0;
            right: 0;
            max-height: 200px; /* Limits height and adds scrollbar if many items */
            overflow-y: auto;
            background-color: #fff; /* White background for readability */
            border-radius: 0 0 0.375rem 0.375rem; /* Rounded bottom corners */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Subtle shadow */
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        /* Style for the active (highlighted) autocomplete item */
        .autocomplete-active {
            background-color: #3B82F6 !important;
            color: #ffffff;
        }

        /* Chart container styling to ensure consistent sizing for canvases */
        .chart-container {
            position: relative;
            height: 250px; /* Fixed height for consistent chart display */
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">

    <!-- Login Screen - Initially visible, hidden after successful login -->
    <div id="loginScreen" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-6" data-translate-key="loginTitle">Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="usernameLabel">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="passwordLabel">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-translate-key="loginBtn">Login</button>
                <p id="loginError" class="text-red-500 text-sm mt-4 hidden" data-translate-key="loginErrorInvalid">Invalid username or password.</p>
            </form>
        </div>
    </div>

    <!-- Main Dashboard Container - Hidden until successful login -->
    <div id="dashboardContainer" class="w-full xl:w-11/12 2xl:w-10/12 bg-white rounded-lg shadow-xl p-6 md:p-8 hidden">
        <!-- Dashboard Header with Logo, Title, and Mode/Currency/Language/Logout Buttons -->
        <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <div class="flex items-center gap-4">
                <!-- Placeholder for Logo -->
                <img src="https://via.placeholder.com/40x40?text=Logo" alt="Company Logo" class="h-10 w-10 rounded-full" id="companyLogo">
                <h1 class="text-3xl font-bold text-gray-800" data-translate-key="marketingDashboardTitle">Business Management Dashboard</h1>
                 <span id="loggedInUserDisplay" class="ml-4 text-gray-600 text-lg font-medium hidden">
                    <span data-translate-key="loggedInAs">Logged in as:</span> <span id="loggedInUserName"></span>
                </span>
            </div>

            <div class="flex flex-wrap items-center gap-4">
                <!-- Dark/Light Mode Toggle -->
                <button id="modeToggle" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 transition duration-150 ease-in-out">
                    <i data-lucide="moon" class="h-5 w-5 inline-block mr-1"></i>
                    <span data-translate-key="darkModeBtn">Dark Mode</span>
                </button>

                <!-- Currency Selection Toggle Button and Dropdown -->
                <div class="relative flex items-center gap-2">
                    <button id="currencyToggleButton" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 transition duration-150 ease-in-out">
                        <span id="currentCurrencyText">USD</span> &#9662;
                    </button>
                    <div id="currencyDropdown" class="absolute top-full right-0 mt-2 w-28 bg-white border border-gray-200 rounded-md shadow-lg hidden z-10">
                        <button class="currency-option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-currency="USD">USD</button>
                        <button class="currency-option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-currency="IQD">IQD</button>
                    </div>
                    <!-- USD to IQD Conversion Rate Input -->
                    <div id="usdToIqdRateContainer" class="flex items-center gap-1 ml-2">
                        <label for="usdToIqdRateInput" class="text-sm font-medium text-gray-700 whitespace-nowrap" data-translate-key="usdToIqdRateLabel">1 USD = </label>
                        <input type="number" id="usdToIqdRateInput" class="w-20 px-2 py-1 border border-gray-300 rounded-md text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500" value="1420" min="1" step="0.01">
                        <span class="text-sm font-medium text-gray-700">IQD</span>
                    </div>
                </div>

                <!-- Language Selection Toggle Button and Dropdown -->
                <div class="relative">
                    <button id="languageToggleButton" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 transition duration-150 ease-in-out">
                        <span id="currentLanguageText">English</span> &#9662;
                    </button>
                    <div id="languageDropdown" class="absolute top-full right-0 mt-2 w-32 bg-white border border-gray-200 rounded-md shadow-lg hidden z-10">
                        <button class="lang-option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="en">English</button>
                        <button class="lang-option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ar">العربية</button>
                        <button class="lang-option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ku">کوردی (سۆرانی)</button>
                    </div>
                </div>

                <!-- Logout Button -->
                <button id="logoutButton" class="px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" data-translate-key="logoutBtn">
                    <i data-lucide="log-out" class="h-5 w-5 inline-block mr-1"></i>
                    Logout
                </button>
            </div>
        </div>


        <!-- Navigation Tabs for different sections of the dashboard -->
        <div class="flex border-b border-gray-200 mb-6 overflow-x-auto whitespace-nowrap">
            <!-- Products Tab Button -->
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:border-blue-300 hover:text-blue-500 transition duration-150 ease-in-out active" data-tab="products" data-allowed-roles="Admin,DataEnterer">
                <i data-lucide="box" class="h-6 w-6 inline-block mr-2"></i>
                <span data-translate-key="productsTab">Products</span>
            </button>
            <!-- Sales/Orders Tab Button -->
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:border-blue-300 hover:text-blue-500 transition duration-150 ease-in-out" data-tab="sales" data-allowed-roles="Admin,Seller">
                <i data-lucide="shopping-cart" class="h-6 w-6 inline-block mr-2"></i>
                <span data-translate-key="salesTab">Sales/Orders</span>
            </button>
            <!-- Storage Tab Button -->
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:border-blue-300 hover:text-blue-500 transition duration-150 ease-in-out" data-tab="storage" data-allowed-roles="Admin,DataEnterer">
                <i data-lucide="warehouse" class="h-6 w-6 inline-block mr-2"></i>
                <span data-translate-key="storageTab">Storage</span>
            </button>
            <!-- Dashboard Tab Button -->
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:border-blue-300 hover:text-blue-500 transition duration-150 ease-in-out" data-tab="dashboard" data-allowed-roles="Admin">
                <i data-lucide="layout-dashboard" class="h-6 w-6 inline-block mr-2"></i>
                <span data-translate-key="dashboardTab">Dashboard</span>
            </button>
             <!-- Campaigns Tab Button -->
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:border-blue-300 hover:text-blue-500 transition duration-150 ease-in-out" data-tab="campaigns" data-allowed-roles="Admin">
                <i data-lucide="megaphone" class="h-6 w-6 inline-block mr-2"></i>
                <span data-translate-key="campaignsTab">Campaigns</span>
            </button>
            <!-- Admin Tab Button -->
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-600 border-b-2 border-transparent hover:border-blue-300 hover:text-blue-500 transition duration-150 ease-in-out" data-tab="admin" data-allowed-roles="Admin">
                <i data-lucide="settings" class="h-6 w-6 inline-block mr-2"></i>
                <span data-translate-key="adminTab">Admin</span>
            </button>
        </div>

        <!-- Tab Content Sections -->

        <!-- Products Tab Content -->
        <div id="productsTabContent" class="tab-content active">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-translate-key="productManagementTitle">Product Management</h2>
            <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-xl font-medium text-gray-700 mb-4" data-translate-key="addNewProductTitle">Add New Product</h3>
                <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="productBarcode" class="block text-sm font-medium text-gray-700" data-translate-key="productBarcodeLabel">Product Barcode</label>
                        <input type="text" id="productBarcode" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700" data-translate-key="productNameLabel">Product Name</label>
                        <input type="text" id="productName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="productType" class="block text-sm font-medium text-gray-700" data-translate-key="productTypeLabel">Product Type</label>
                        <input type="text" id="productType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="brandName" class="block text-sm font-medium text-gray-700" data-translate-key="brandNameLabel">Brand Name</label>
                        <input type="text" id="brandName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="boughtPrice" class="block text-sm font-medium text-gray-700" data-translate-key="boughtPriceLabel">Bought Price</label>
                        <input type="number" id="boughtPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label for="sellPrice" class="block text-sm font-medium text-gray-700" data-translate-key="sellPriceLabel">Sell Price</label>
                        <input type="number" id="sellPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label for="productQuantity" class="block text-sm font-medium text-gray-700" data-translate-key="productQuantityLabel">Quantity</label>
                        <input type="number" id="productQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" min="0" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="productDescription" class="block text-sm font-medium text-gray-700" data-translate-key="productDescriptionLabel">Description</label>
                        <textarea id="productDescription" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="px-5 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" data-translate-key="addProductBtn">Add Product</button>
                    </div>
                </form>
            </div>

            <h3 class="text-xl font-medium text-gray-700 mb-4" data-translate-key="productListTitle">Product List</h3>
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderId">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderBarcode">Barcode</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderProductName">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderProductType">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderBrandName">Brand</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderBoughtPrice">Bought Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderSellPrice">Sell Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderQuantity">Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderDiscount">Discount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderDescription">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderActions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productList" class="bg-white divide-y divide-gray-200">
                        <!-- Product rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales/Orders Tab Content -->
        <div id="salesTabContent" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-translate-key="salesManagementTitle">Sales/Order Management</h2>
            <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-xl font-medium text-gray-700 mb-4" data-translate-key="recordNewSaleTitle">Record New Sale</h3>
                <div class="flex flex-wrap gap-4 items-end mb-4">
                    <div class="relative flex-1 min-w-[200px]">
                        <label for="saleProductBarcode" class="block text-sm font-medium text-gray-700 rounded-md p-2 bg-yellow-100 border border-yellow-200" data-translate-key="saleProductBarcodeLabel">Scan/Enter Barcode</label>
                        <input type="text" id="saleProductBarcode" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="relative flex-1 min-w-[200px]">
                        <label for="saleProductName" class="block text-sm font-medium text-gray-700 rounded-md p-2 bg-yellow-100 border border-yellow-200" data-translate-key="saleProductNameLabel">Item Name</label>
                        <input type="text" id="saleProductName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <div id="productSuggestions" class="autocomplete-items"></div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg shadow-sm overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderBarcode">Bar Code</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="saleProductNameLabel">Item Name</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderSellPrice">Sell Price</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderQuantity">Qunt</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderTotalPrice">Total Price</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderRemainQuantity">Remain Qunt</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderActions"></th>
                            </tr>
                        </thead>
                        <tbody id="currentSaleTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Current sale items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="flex flex-wrap justify-between items-center mt-6">
                    <button id="recordSaleButton" class="px-5 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" data-translate-key="recordSaleBtn">Record Sale</button>
                    <div class="flex items-center gap-2">
                        <label class="text-lg font-medium text-gray-700" data-translate-key="totalPriceLabel">Total Price</label>
                        <input type="text" id="currentSaleTotalPrice" class="w-48 px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-lg font-bold text-right text-left-ltr" value="$0.00" readonly>
                    </div>
                </div>
            </div>

            <h3 class="text-xl font-medium text-gray-700 mb-4" data-translate-key="salesHistoryTitle">Sales History</h3>
            <div class="mb-4">
                <input type="text" id="salesSearchInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Search sales by product or customer..." data-translate-key="searchSalesPlaceholder">
            </div>
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderSaleId">Sale ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderSaleProductName">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderSaleQuantity">Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderSalePrice">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderCustomerName">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderSaleDate">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderSoldBy">Sold By</th> <!-- New Header -->
                        </tr>
                    </thead>
                    <tbody id="salesList" class="bg-white divide-y divide-gray-200">
                        <!-- Sales rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Storage Tab Content -->
        <div id="storageTabContent" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-translate-key="storageManagementTitle">Storage Management</h2>
            <div class="mb-4">
                <input type="text" id="storageSearchInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Search storage items..." data-translate-key="searchStoragePlaceholder">
            </div>
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderId">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderBarcode">Barcode</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderProductName">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderQuantity">Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderStatus">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderLastUpdate">Last Update</th>
                        </tr>
                    </thead>
                    <tbody id="storageList" class="bg-white divide-y divide-gray-200">
                        <!-- Storage items will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard/Reports Tab Content -->
        <div id="dashboardTabContent" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex justify-between items-center">
                <span data-translate-key="dashboardOverviewTitle">Dashboard Overview</span>
                <div class="flex items-center gap-2">
                    <button id="refreshDashboardBtn" class="px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" data-translate-key="refreshBtn">
                        <i data-lucide="refresh-cw" class="h-5 w-5 inline-block mr-1"></i>
                        Refresh
                    </button>
                    <button id="generateReportBtn" class="px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-translate-key="generateReportBtn">
                        <i data-lucide="file-text" class="h-5 w-5 inline-block mr-1"></i>
                        Generate Report
                    </button>
                </div>
            </h2>

            <div class="mb-6 flex items-center gap-4">
                <label class="text-sm font-medium text-gray-700" data-translate-key="viewByLabel">View By:</label>
                <select id="timePeriodFilter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="day" data-translate-key="dayOption">Day</option>
                    <option value="week" data-translate-key="weekOption">Week</option>
                    <option value="month" selected data-translate-key="monthOption">Month</option>
                </select>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-lg shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-blue-700" data-translate-key="totalRevenueCard">Total Revenue</p>
                        <p id="totalRevenue" class="text-2xl font-bold text-blue-900">$0</p>
                    </div>
                    <i data-lucide="dollar-sign" class="h-8 w-8 text-blue-600"></i>
                </div>
                <div class="bg-green-100 p-4 rounded-lg shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-green-700" data-translate-key="totalProfitCard">Total Profit</p>
                        <p id="totalProfit" class="text-2xl font-bold text-green-900">$0</p>
                    </div>
                    <i data-lucide="trending-up" class="h-8 w-8 text-green-600"></i>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-yellow-700" data-translate-key="totalItemsSoldCard">Total Items Sold</p>
                        <p id="totalItemsSold" class="text-2xl font-bold text-yellow-900">0</p>
                    </div>
                    <i data-lucide="package" class="h-8 w-8 text-yellow-600"></i>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-purple-700" data-translate-key="avgOrderValueCard">Avg. Order Value</p>
                        <p id="avgOrderValue" class="text-2xl font-bold text-purple-900">$0</p>
                    </div>
                    <i data-lucide="receipt" class="h-8 w-8 text-purple-600"></i>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold mb-4" data-translate-key="revenueOverTimeChart">Revenue Over Time</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold mb-4" data-translate-key="salesByProductCategoryChart">Sales by Product Type</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <!-- New Chart: Sales by Seller -->
                <div class="bg-white p-4 rounded-lg shadow-sm lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-4" data-translate-key="salesBySellerChart">Sales by Seller</h3>
                    <div class="chart-container">
                        <canvas id="salesBySellerChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold mb-4" data-translate-key="recentActivitiesTitle">Recent Activities</h3>
                <ul id="recentActivitiesList" class="space-y-3">
                    <!-- Activities will be dynamically inserted here -->
                </ul>
            </div>
        </div>

        <!-- Campaigns Tab Content -->
        <div id="campaignsTabContent" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-translate-key="campaignManagementTitle">Campaign Management</h2>
            <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-xl font-medium text-gray-700 mb-4" data-translate-key="addNewCampaignTitle">Add New Campaign</h3>
                <form id="addCampaignForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="campaignName" class="block text-sm font-medium text-gray-700" data-translate-key="campaignNameLabel">Campaign Name</label>
                        <input type="text" id="campaignName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="campaignPlatform" class="block text-sm font-medium text-gray-700" data-translate-key="campaignPlatformLabel">Platform</label>
                        <input type="text" id="campaignPlatform" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="campaignBudget" class="block text-sm font-medium text-gray-700" data-translate-key="campaignBudgetLabel">Budget</label>
                        <input type="number" id="campaignBudget" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label for="campaignDuration" class="block text-sm font-medium text-gray-700" data-translate-key="campaignDurationLabel">Duration (Days)</label>
                        <input type="number" id="campaignDuration" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" min="1" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="campaignAudience" class="block text-sm font-medium text-gray-700" data-translate-key="campaignAudienceLabel">Audience</label>
                        <textarea id="campaignAudience" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="px-5 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" data-translate-key="addCampaignBtn">Add Campaign</button>
                    </div>
                </form>
            </div>

            <h3 class="text-xl font-medium text-gray-700 mb-4" data-translate-key="campaignListTitle">Campaign List</h3>
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderCampaignName">Campaign Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderPlatform">Platform</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderBudget">Budget</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderDuration">Duration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderAudience">Audience</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderActions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="campaignList" class="bg-white divide-y divide-gray-200">
                        <!-- Campaign rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>


        <!-- Admin Tab Content (User Management) -->
        <div id="adminTabContent" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6" data-translate-key="userManagementTitle">User Management</h2>
            <div class="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 class="text-xl font-medium text-gray-700 mb-4" data-translate-key="addNewUserTitle">Add New User</h3>
                <form id="addUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="newUsername" class="block text-sm font-medium text-gray-700" data-translate-key="usernameLabel">Username</label>
                        <input type="text" id="newUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="newUserFullName" class="block text-sm font-medium text-gray-700" data-translate-key="fullNameLabel">Full Name</label>
                        <input type="text" id="newUserFullName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="newUserPassword" class="block text-sm font-medium text-gray-700" data-translate-key="passwordLabel">Password</label>
                        <input type="password" id="newUserPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="newUserRole" class="block text-sm font-medium text-gray-700" data-translate-key="roleLabel">Role</label>
                        <select id="newUserRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="Seller" data-translate-key="roleSeller">Seller</option>
                            <option value="DataEnterer" data-translate-key="roleDataEntry">Data Entry</option>
                            <option value="Admin" data-translate-key="roleAdmin">Admin</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="px-5 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" data-translate-key="addUserBtn">Add User</button>
                    </div>
                </form>
            </div>

            <h3 class="text-xl font-medium text-gray-700 mb-4" data-translate-key="userListTitle">User List</h3>
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderUsername">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderFullName">Full Name</th> <!-- New Header -->
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderRole">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate-key="tableHeaderActions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userList" class="bg-white divide-y divide-gray-200">
                        <!-- User rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Modals for Product Edit, Discount, Report, QR Code, and User Edit -->

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editProductModal')">&times;</span>
            <h2 class="text-xl font-bold mb-4" data-translate-key="editProductTitle">Edit Product</h2>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="mb-4">
                    <label for="editProductBarcode" class="block text-sm font-medium text-gray-700" data-translate-key="productBarcodeLabel">Product Barcode</label>
                    <input type="text" id="editProductBarcode" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="editProductName" class="block text-sm font-medium text-gray-700" data-translate-key="productNameLabel">Product Name</label>
                    <input type="text" id="editProductName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="editProductType" class="block text-sm font-medium text-gray-700" data-translate-key="productTypeLabel">Product Type</label>
                    <input type="text" id="editProductType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="editBrandName" class="block text-sm font-medium text-gray-700" data-translate-key="brandNameLabel">Brand Name</label>
                    <input type="text" id="editBrandName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="editBoughtPrice" class="block text-sm font-medium text-gray-700" data-translate-key="boughtPriceLabel">Bought Price</label>
                    <input type="number" id="editBoughtPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" min="0" step="0.01" required>
                </div>
                <div class="mb-4">
                    <label for="editSellPrice" class="block text-sm font-medium text-gray-700" data-translate-key="sellPriceLabel">Sell Price</label>
                    <input type="number" id="editSellPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" min="0" step="0.01" required>
                </div>
                <div class="mb-4">
                    <label for="editProductQuantity" class="block text-sm font-medium text-gray-700" data-translate-key="productQuantityLabel">Quantity</label>
                    <input type="number" id="editProductQuantity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" min="0" required>
                </div>
                <div class="mb-6">
                    <label for="editProductDescription" class="block text-sm font-medium text-gray-700" data-translate-key="productDescriptionLabel">Description</label>
                    <textarea id="editProductDescription" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition" data-translate-key="saveChangesBtn">Save Changes</button>
                    <button type="button" class="ml-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition" onclick="closeModal('editProductModal')" data-translate-key="cancelBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Discount Modal -->
    <div id="discountModal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('discountModal')">&times;</span>
            <h2 class="text-xl font-bold mb-4" data-translate-key="setDiscountTitle">Set Discount</h2>
            <form id="discountForm">
                <input type="hidden" id="discountProductId">
                <div class="mb-4">
                    <label for="discountOriginalPrice" class="block text-sm font-medium text-gray-700" data-translate-key="originalSellPriceLabel">Original Sell Price</label>
                    <input type="text" id="discountOriginalPrice" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" readonly>
                </div>
                <div class="mb-4">
                    <label for="discountPercentage" class="block text-sm font-medium text-gray-700" data-translate-key="discountPercentageLabel">Discount Percentage (%)</label>
                    <input type="number" id="discountPercentage" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" min="0" max="100" step="0.01">
                </div>
                <div class="mb-4">
                    <label for="discountExpiryDate" class="block text-sm font-medium text-gray-700" data-translate-key="discountExpiryDateLabel">Expiry Date</label>
                    <input type="text" id="discountExpiryDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md flatpickr-input" placeholder="Select date">
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition" data-translate-key="applyDiscountBtn">Apply Discount</button>
                    <button type="button" class="ml-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition" onclick="closeModal('discountModal')" data-translate-key="cancelBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('qrCodeModal')">&times;</span>
            <h2 class="text-xl font-bold mb-4" data-translate-key="qrCodeTitle">Product QR Code</h2>
            <div id="qrCodeDisplayArea" class="qr-code-display p-4 bg-gray-100 rounded-md">
                <!-- QR code content will be displayed here -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition" onclick="closeModal('qrCodeModal')" data-translate-key="closeBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Report Generation Modal -->
    <div id="reportModal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('reportModal')">&times;</span>
            <h2 class="text-xl font-bold mb-4" data-translate-key="generateReportTitle">Generate Report</h2>
            <p class="mb-4" data-translate-key="selectReportFormat">Select report format:</p>
            <div class="flex flex-col gap-3">
                <button class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition" onclick="generateReport('pdf')" data-translate-key="reportPdfBtn">Generate PDF Report</button>
                <button class="w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition" onclick="generateReport('excel')" data-translate-key="reportExcelBtn">Generate Excel Report</button>
                <button class="w-full px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition" onclick="generateReport('word')" data-translate-key="reportWordBtn">Generate Word Report</button>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition" onclick="closeModal('reportModal')" data-translate-key="cancelBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editUserModal')">&times;</span>
            <h2 class="text-xl font-bold mb-4" data-translate-key="editUserTitle">Edit User</h2>
            <form id="editUserForm">
                <input type="hidden" id="originalUsername">
                <div class="mb-4">
                    <label for="editUsername" class="block text-sm font-medium text-gray-700" data-translate-key="usernameLabel">Username</label>
                    <input type="text" id="editUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="editUserFullName" class="block text-sm font-medium text-gray-700" data-translate-key="fullNameLabel">Full Name</label>
                    <input type="text" id="editUserFullName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="editUserPassword" class="block text-sm font-medium text-gray-700" data-translate-key="passwordLabel">Password</label>
                    <input type="password" id="editUserPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Leave blank to keep current password">
                </div>
                <div class="mb-6">
                    <label for="editUserRole" class="block text-sm font-medium text-gray-700" data-translate-key="roleLabel">Role</label>
                    <select id="editUserRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        <option value="Seller" data-translate-key="roleSeller">Seller</option>
                        <option value="DataEnterer" data-translate-key="roleDataEntry">Data Entry</option>
                        <option value="Admin" data-translate-key="roleAdmin">Admin</option>
                    </select>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition" data-translate-key="updateUserBtn">Update User</button>
                    <button type="button" class="ml-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition" onclick="closeModal('editUserModal')" data-translate-key="cancelBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Initialize Lucide icons on the page
        lucide.createIcons();

        // --- Core Data Storage (In-memory for this single-file example) ---
        // In a real application, this would interact with a backend database.
        let products = [
            { id: 'prod-1', barcode: '123456789012', name: 'Laptop Pro X', type: 'Electronics', brand: 'TechCo', boughtPrice: 1000.00, sellPrice: 1200.00, quantity: 15, description: 'High-performance laptop for professionals.', status: 'available', discount: null, discountExpiry: null },
            { id: 'prod-2', barcode: '234567890123', name: 'Wireless Mouse', type: 'Accessories', brand: 'ErgoGear', boughtPrice: 20.00, sellPrice: 25.50, quantity: 50, description: 'Ergonomic wireless mouse with long battery life.', status: 'available', discount: null, discountExpiry: null },
            { id: 'prod-3', barcode: '345678901234', name: 'Mechanical Keyboard', type: 'Peripherals', brand: 'KeyMaster', boughtPrice: 60.00, sellPrice: 80.00, quantity: 30, description: 'RGB mechanical keyboard with tactile switches.', status: 'available', discount: null, discountExpiry: null },
            { id: 'prod-4', barcode: '456789012345', name: '4K Monitor 27"', type: 'Electronics', brand: 'ViewMax', boughtPrice: 300.00, sellPrice: 350.00, quantity: 10, description: '27-inch 4K UHD monitor for stunning visuals.', status: 'available', discount: null, discountExpiry: null },
            { id: 'prod-5', barcode: '567890123456', name: 'USB-C Hub', type: 'Accessories', brand: 'ConnectAll', boughtPrice: 35.00, sellPrice: 45.00, quantity: 70, description: 'Multi-port USB-C hub with HDMI, USB, and SD card slots.', status: 'available', discount: null, discountExpiry: null }
        ];

        let sales = [
            { id: 'sale-1', productId: 'prod-1', productName: 'Laptop Pro X', productType: 'Electronics', brandName: 'TechCo', quantity: 1, originalSellPrice: 1200.00, finalSellPrice: 1200.00, customerName: 'Alice Johnson', date: '2023-01-10', sellerName: 'Sarah Seller' },
            { id: 'sale-2', productId: 'prod-2', productName: 'Wireless Mouse', productType: 'Accessories', brandName: 'ErgoGear', quantity: 2, originalSellPrice: 25.50, finalSellPrice: 25.50, customerName: 'Bob Williams', date: '2023-01-11', sellerName: 'John Admin' },
            { id: 'sale-3', productId: 'prod-4', productName: '4K Monitor 27"', productType: 'Electronics', brandName: 'ViewMax', quantity: 1, originalSellPrice: 350.00, finalSellPrice: 350.00, customerName: 'Charlie Brown', date: '2023-01-12', sellerName: 'Sarah Seller' },
        ];

        let campaigns = []; // New array for campaigns
        let currentSaleItems = []; // Array to hold items for the current sale

        // Dummy data for dashboard metrics and charts
        let dashboardData = {
            totalRevenue: 0,
            totalProfit: 0,
            totalItemsSold: 0,
            avgOrderValue: 0,
            revenueOverTime: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                data: [0, 0, 0, 0, 0, 0] // Will be dynamically populated
            },
            salesByProductType: { // Changed from category to type
                labels: [], // Will be dynamically populated
                data: []
            },
            salesBySeller: { // New: Sales by Seller
                labels: [],
                data: []
            },
            recentActivities: [
                { id: 'act-1', description: 'System Initialized.', date: new Date().toLocaleDateString('en-US') },
            ]
        };

        // --- Translations Object ---
        const translations = {
            en: {
                documentTitle: "Business Management Dashboard",
                loginTitle: "Login",
                usernameLabel: "Username",
                passwordLabel: "Password",
                loginBtn: "Login",
                loginErrorInvalid: "Invalid username or password.",
                marketingDashboardTitle: "Business Management Dashboard",
                usdToIqdRateLabel: "1 USD = ",
                loggedInAs: "Logged in as:",
                productsTab: "Products",
                salesTab: "Sales/Orders",
                storageTab: "Storage",
                dashboardTab: "Dashboard",
                campaignsTab: "Campaigns",
                adminTab: "Admin",
                logoutBtn: "Logout",
                darkModeBtn: "Dark Mode",
                lightModeBtn: "Light Mode",
                productManagementTitle: "Product Management",
                addNewProductTitle: "Add New Product",
                productBarcodeLabel: "Product Barcode",
                productNameLabel: "Product Name",
                productTypeLabel: "Product Type",
                brandNameLabel: "Brand Name",
                boughtPriceLabel: "Bought Price",
                sellPriceLabel: "Sell Price",
                productQuantityLabel: "Quantity",
                productDescriptionLabel: "Description",
                addProductBtn: "Add Product",
                productListTitle: "Product List",
                tableHeaderId: "ID",
                tableHeaderBarcode: "Barcode",
                tableHeaderProductName: "Product Name",
                tableHeaderProductType: "Type",
                tableHeaderBrandName: "Brand",
                tableHeaderBoughtPrice: "Bought Price",
                tableHeaderSellPrice: "Sell Price",
                tableHeaderQuantity: "Quantity",
                tableHeaderDiscount: "Discount",
                tableHeaderDescription: "Description",
                tableHeaderActions: "Actions",
                editBtn: "Edit",
                deleteBtn: "Delete",
                showQRBtn: "Show QR",
                setDiscountBtn: "Set Discount",
                salesManagementTitle: "Sales/Order Management",
                recordNewSaleTitle: "Record New Sale",
                saleProductBarcodeLabel: "Bar Code",
                saleProductNameLabel: "Item Name",
                saleProductTypeLabel: "Product Type",
                saleBrandNameLabel: "Brand Name",
                saleSellPriceLabel: "Sell Price (Current)",
                saleQuantityLabel: "Quantity Sold",
                customerNameLabel: "Customer Name",
                recordSaleBtn: "Record Sale",
                salesHistoryTitle: "Sales History",
                searchSalesPlaceholder: "Search sales by product or customer...",
                tableHeaderSaleId: "Sale ID",
                tableHeaderSaleProductName: "Product",
                tableHeaderSaleQuantity: "Quantity",
                tableHeaderSalePrice: "Price",
                tableHeaderCustomerName: "Customer",
                tableHeaderSaleDate: "Date",
                tableHeaderSoldBy: "Sold By",
                storageManagementTitle: "Storage Management",
                searchStoragePlaceholder: "Search storage items...",
                tableHeaderStatus: "Status",
                tableHeaderLastUpdate: "Last Update",
                statusAvailable: "Available",
                statusNotAvailable: "Not Available",
                statusDeleted: "Deleted",
                dashboardOverviewTitle: "Dashboard Overview",
                refreshBtn: "Refresh",
                generateReportBtn: "Generate Report",
                viewByLabel: "View By:",
                dayOption: "Day",
                weekOption: "Week",
                monthOption: "Month",
                totalRevenueCard: "Total Revenue",
                totalProfitCard: "Total Profit",
                totalItemsSoldCard: "Total Items Sold",
                avgOrderValueCard: "Avg. Order Value",
                revenueOverTimeChart: "Revenue Over Time",
                customerAcquisitionChart: "Customer Acquisition",
                salesByProductCategoryChart: "Sales by Product Type",
                salesBySellerChart: "Sales by Seller",
                websiteTrafficSourcesChart: "Website Traffic Sources",
                recentActivitiesTitle: "Recent Activities",
                editProductTitle: "Edit Product",
                saveChangesBtn: "Save Changes",
                cancelBtn: "Cancel",
                qrCodeTitle: "Product QR Code",
                closeBtn: "Close",
                setDiscountTitle: "Set Discount",
                originalSellPriceLabel: "Original Sell Price",
                discountPercentageLabel: "Discount Percentage (%)",
                discountExpiryDateLabel: "Expiry Date",
                applyDiscountBtn: "Apply Discount",
                productNotFound: "Product not found.",
                insufficientStock: "Insufficient stock.",
                confirmDeleteProduct: "Are you sure you want to delete this product?",
                recentActivityAddedProduct: "Added new product",
                recentActivityUpdatedProduct: "Updated product",
                recentActivityDeletedProduct: "Deleted product",
                recentActivityRecordedSale: "Recorded new sale for",
                userManagementTitle: "User Management",
                addNewUserTitle: "Add New User",
                fullNameLabel: "Full Name",
                roleLabel: "Role",
                roleSeller: "Seller",
                roleDataEntry: "Data Entry",
                roleAdmin: "Admin",
                addUserBtn: "Add User",
                userListTitle: "User List",
                tableHeaderUsername: "Username",
                tableHeaderFullName: "Full Name",
                tableHeaderRole: "Role",
                confirmDeleteUser: "Are you sure you want to delete this user?",
                userDeleted: "User deleted successfully!",
                userAdded: "User added successfully!",
                editUserTitle: "Edit User", // New translation
                updateUserBtn: "Update User", // New translation
                campaignManagementTitle: "Campaign Management",
                addNewCampaignTitle: "Add New Campaign",
                campaignNameLabel: "Campaign Name",
                campaignPlatformLabel: "Platform",
                campaignBudgetLabel: "Budget",
                campaignDurationLabel: "Duration (Days)",
                campaignAudienceLabel: "Audience",
                addCampaignBtn: "Add Campaign",
                campaignListTitle: "Campaign List",
                tableHeaderCampaignName: "Campaign Name",
                tableHeaderPlatform: "Platform",
                tableHeaderBudget: "Budget",
                tableHeaderDuration: "Duration",
                tableHeaderAudience: "Audience",
                confirmDeleteCampaign: "Are you sure you want to delete this campaign?",
                reportGenerated: "Report generated successfully in {format} format!",
                selectReportFormat: "Select report format:",
                reportPdfBtn: "Generate PDF Report",
                reportExcelBtn: "Generate Excel Report",
                reportWordBtn: "Generate Word Report",
                productBarcodeExists: "Product with this barcode already exists.",
                barcodeScanInstructions: "Enter barcode to autofill product details.",
                tableHeaderTotalPrice: "Total Price",
                tableHeaderRemainQuantity: "Remain Qunt",
                totalPriceLabel: "Total Price",
            },
            ar: {
                documentTitle: "لوحة تحكم إدارة الأعمال",
                loginTitle: "تسجيل الدخول",
                usernameLabel: "اسم المستخدم",
                passwordLabel: "كلمة المرور",
                loginBtn: "تسجيل الدخول",
                loginErrorInvalid: "اسم المستخدم أو كلمة المرور غير صالحة.",
                marketingDashboardTitle: "لوحة تحكم إدارة الأعمال",
                usdToIqdRateLabel: "1 دولار أمريكي = ",
                loggedInAs: "تم تسجيل الدخول باسم:",
                productsTab: "المنتجات",
                salesTab: "المبيعات/الطلبات",
                storageTab: "المخزن",
                dashboardTab: "لوحة التحكم",
                campaignsTab: "الحملات",
                adminTab: "الإدارة",
                logoutBtn: "تسجيل خروج",
                darkModeBtn: "الوضع الداكن",
                lightModeBtn: "الوضع الفاتح",
                productManagementTitle: "إدارة المنتجات",
                addNewProductTitle: "إضافة منتج جديد",
                productBarcodeLabel: "رمز المنتج (باركود)",
                productNameLabel: "اسم المنتج",
                productTypeLabel: "نوع المنتج",
                brandNameLabel: "اسم الماركة",
                boughtPriceLabel: "سعر الشراء",
                sellPriceLabel: "سعر البيع",
                productQuantityLabel: "الكمية",
                productDescriptionLabel: "الوصف",
                addProductBtn: "إضافة منتج",
                productListTitle: "قائمة المنتجات",
                tableHeaderId: "المعرف",
                tableHeaderBarcode: "باركود",
                tableHeaderProductName: "اسم المنتج",
                tableHeaderProductType: "النوع",
                tableHeaderBrandName: "الماركة",
                tableHeaderBoughtPrice: "سعر الشراء",
                tableHeaderSellPrice: "سعر البيع",
                tableHeaderQuantity: "الكمية",
                tableHeaderDiscount: "الخصم",
                tableHeaderDescription: "الوصف",
                tableHeaderActions: "الإجراءات",
                editBtn: "تعديل",
                deleteBtn: "حذف",
                showQRBtn: "عرض QR",
                setDiscountBtn: "تحديد خصم",
                salesManagementTitle: "إدارة المبيعات/الطلبات",
                recordNewSaleTitle: "تسجيل عملية بيع جديدة",
                saleProductBarcodeLabel: "باركود",
                saleProductNameLabel: "اسم العنصر",
                saleProductTypeLabel: "نوع المنتج",
                saleBrandNameLabel: "اسم الماركة",
                saleSellPriceLabel: "سعر البيع (الحالي)",
                saleQuantityLabel: "الكمية المباعة",
                customerNameLabel: "اسم العميل",
                recordSaleBtn: "تسجيل البيع",
                salesHistoryTitle: "سجل المبيعات",
                searchSalesPlaceholder: "البحث في المبيعات بالمنتج أو العميل...",
                tableHeaderSaleId: "معرف البيع",
                tableHeaderSaleProductName: "المنتج",
                tableHeaderSaleQuantity: "الكمية",
                tableHeaderSalePrice: "السعر",
                tableHeaderCustomerName: "العميل",
                tableHeaderSaleDate: "التاريخ",
                tableHeaderSoldBy: "المباع بواسطة",
                storageManagementTitle: "إدارة المخزن",
                searchStoragePlaceholder: "البحث في عناصر المخزن...",
                tableHeaderStatus: "الحالة",
                tableHeaderLastUpdate: "آخر تحديث",
                statusAvailable: "متاح",
                statusNotAvailable: "غير متاح",
                statusDeleted: "محذوف",
                dashboardOverviewTitle: "نظرة عامة على لوحة التحكم",
                refreshBtn: "تحديث",
                generateReportBtn: "توليد تقرير",
                viewByLabel: "عرض حسب:",
                dayOption: "اليوم",
                weekOption: "الأسبوع",
                monthOption: "الشهر",
                totalRevenueCard: "إجمالي الإيرادات",
                totalProfitCard: "إجمالي الأرباح",
                totalItemsSoldCard: "إجمالي العناصر المباعة",
                avgOrderValueCard: "متوسط قيمة الطلب",
                revenueOverTimeChart: "الإيرادات بمرور الوقت",
                salesByProductCategoryChart: "المبيعات حسب نوع المنتج",
                salesBySellerChart: "المبيعات حسب البائع",
                recentActivitiesTitle: "الأنشطة الأخيرة",
                editProductTitle: "تعديل المنتج",
                saveChangesBtn: "حفظ التغييرات",
                cancelBtn: "إلغاء",
                qrCodeTitle: "رمز QR للمنتج",
                closeBtn: "إغلاق",
                setDiscountTitle: "تحديد خصم",
                originalSellPriceLabel: "سعر البيع الأصلي",
                discountPercentageLabel: "نسبة الخصم (%)",
                discountExpiryDateLabel: "تاريخ انتهاء الصلاحية",
                applyDiscountBtn: "تطبيق الخصم",
                productNotFound: "المنتج غير موجود.",
                insufficientStock: "المخزون غير كاف.",
                confirmDeleteProduct: "هل أنت متأكد من حذف هذا المنتج؟",
                recentActivityAddedProduct: "تمت إضافة منتج جديد",
                recentActivityUpdatedProduct: "تم تحديث المنتج",
                recentActivityDeletedProduct: "تم حذف المنتج",
                recentActivityRecordedSale: "تم تسجيل عملية بيع جديدة لـ",
                userManagementTitle: "إدارة المستخدمين",
                addNewUserTitle: "إضافة مستخدم جديد",
                fullNameLabel: "الاسم الكامل",
                roleLabel: "الدور",
                roleSeller: "بائع",
                roleDataEntry: "مدخل بيانات",
                roleAdmin: "مسؤول",
                addUserBtn: "إضافة مستخدم",
                userListTitle: "قائمة المستخدمين",
                tableHeaderUsername: "اسم المستخدم",
                tableHeaderFullName: "الاسم الكامل",
                tableHeaderRole: "الدور",
                confirmDeleteUser: "هل أنت متأكد من حذف هذا المستخدم؟",
                userDeleted: "تم حذف المستخدم بنجاح!",
                userAdded: "تمت إضافة المستخدم بنجاح!",
                editUserTitle: "تعديل المستخدم", // New translation
                updateUserBtn: "تحديث المستخدم", // New translation
                campaignManagementTitle: "إدارة الحملات",
                addNewCampaignTitle: "إضافة حملة جديدة",
                campaignNameLabel: "اسم الحملة",
                campaignPlatformLabel: "المنصة",
                campaignBudgetLabel: "الميزانية",
                campaignDurationLabel: "المدة (أيام)",
                campaignAudienceLabel: "الجمهور المستهدف",
                addCampaignBtn: "إضافة حملة",
                campaignListTitle: "قائمة الحملات",
                tableHeaderCampaignName: "اسم الحملة",
                tableHeaderPlatform: "المنصة",
                tableHeaderBudget: "الميزانية",
                tableHeaderDuration: "المدة",
                tableHeaderAudience: "الجمهور",
                confirmDeleteCampaign: "هل أنت متأكد من حذف هذه الحملة؟",
                reportGenerated: "تم إنشاء التقرير بنجاح بصيغة {format}!",
                selectReportFormat: "اختر تنسيق التقرير:",
                reportPdfBtn: "إنشاء تقرير PDF",
                reportExcelBtn: "إنشاء تقرير Excel",
                reportWordBtn: "إنشاء تقرير Word",
                productBarcodeExists: "منتج بهذا الباركود موجود بالفعل.",
                barcodeScanInstructions: "أدخل الباركود لملء تفاصيل المنتج تلقائياً.",
                tableHeaderTotalPrice: "السعر الإجمالي",
                tableHeaderRemainQuantity: "الكمية المتبقية",
                totalPriceLabel: "السعر الإجمالي",
            },
            ku: {
                documentTitle: "داشبۆردی بەڕێوەبردنی کار",
                loginTitle: "چوونە ژوورەوە",
                usernameLabel: "ناوی بەکارهێنەر",
                passwordLabel: "وشەی نهێنی",
                loginBtn: "چوونە ژوورەوە",
                loginErrorInvalid: "ناوی بەکارهێنەر یان وشەی نهێنی نادروستە.",
                marketingDashboardTitle: "داشبۆردی بەڕێوەبردنی کار",
                usdToIqdRateLabel: "1 دۆلار = ",
                loggedInAs: "چوونە ژوورەوە وەک:",
                productsTab: "بەرهەمەکان",
                salesTab: "فرۆشراوەکان/داواکارییەکان",
                storageTab: "کۆگا",
                dashboardTab: "داشبۆرد",
                campaignsTab: "کامپەینەکان",
                adminTab: "بەڕێوەبردن",
                logoutBtn: "چوونە دەرەوە",
                darkModeBtn: "دۆخی تاریک",
                lightModeBtn: "دۆخی ڕووناک",
                productManagementTitle: "بەڕێوەبردنی بەرهەم",
                addNewProductTitle: "زیادکردنی بەرهەمی نوێ",
                productBarcodeLabel: "بارکۆدی بەرهەم",
                productNameLabel: "ناوی بەرهەم",
                productTypeLabel: "جۆری بەرهەم",
                brandNameLabel: "ناوی مارکە",
                boughtPriceLabel: "نرخی کڕین",
                sellPriceLabel: "نرخی فرۆشتن",
                productQuantityLabel: "بڕ",
                productDescriptionLabel: "وەسف",
                addProductBtn: "زیادکردنی بەرهەم",
                productListTitle: "لیستی بەرهەمەکان",
                tableHeaderId: "ناسنامە",
                tableHeaderBarcode: "بارکۆد",
                tableHeaderProductName: "ناوی بەرهەم",
                tableHeaderProductType: "جۆر",
                tableHeaderBrandName: "مارکە",
                tableHeaderBoughtPrice: "نرخی کڕین",
                tableHeaderSellPrice: "نرخی فرۆشتن",
                tableHeaderQuantity: "بڕ",
                tableHeaderDiscount: "داشکاندن",
                tableHeaderDescription: "وەسف",
                tableHeaderActions: "کردارەکان",
                editBtn: "دەستکاری",
                deleteBtn: "سڕینەوە",
                showQRBtn: "پیشاندانی QR",
                setDiscountBtn: "دانانی داشکاندن",
                salesManagementTitle: "بەڕێوەبردنی فرۆشراوەکان/داواکارییەکان",
                recordNewSaleTitle: "تۆمارکردنی فرۆشراوی نوێ",
                saleProductBarcodeLabel: "بارکۆد",
                saleProductNameLabel: "ناوی شت",
                saleProductTypeLabel: "جۆری بەرهەم",
                saleBrandNameLabel: "ناوی مارکە",
                saleSellPriceLabel: "نرخی فرۆشتن (ئێستا)",
                saleQuantityLabel: "بڕی فرۆشراو",
                customerNameLabel: "ناوی کڕیار",
                recordSaleBtn: "تۆمارکردنی فرۆشراو",
                salesHistoryTitle: "مێژووی فرۆشراوەکان",
                searchSalesPlaceholder: "گەڕان بەدوای فرۆشراوەکان بەپێی بەرهەم یان کڕیار...",
                tableHeaderSaleId: "ناسنامەی فرۆشراو",
                tableHeaderSaleProductName: "بەرهەم",
                tableHeaderSaleQuantity: "بڕ",
                tableHeaderSalePrice: "نرخ",
                tableHeaderCustomerName: "کڕیار",
                tableHeaderSaleDate: "رێکەوت",
                tableHeaderSoldBy: "فرۆشراوە لەلایەن",
                storageManagementTitle: "بەڕێوەبردنی کۆگا",
                searchStoragePlaceholder: "گەڕان بەدوای کەلوپەلەکانی کۆگا...",
                tableHeaderStatus: "بارودۆخ",
                tableHeaderLastUpdate: "دوایین نوێکردنەوە",
                statusAvailable: "بەردەست",
                statusNotAvailable: "بەردەست نییە",
                statusDeleted: "سڕاوەتەوە",
                dashboardOverviewTitle: "پوختەی داشبۆرد",
                refreshBtn: "نوێکردنەوە",
                generateReportBtn: "دروستکردنی ڕاپۆرت",
                viewByLabel: "بینین بەپێی:",
                dayOption: "ڕۆژ",
                weekOption: "هەفتە",
                monthOption: "مانگ",
                totalRevenueCard: "کۆی داهات",
                totalProfitCard: "کۆی قازانج",
                totalItemsSoldCard: "کۆی کاڵا فرۆشراوەکان",
                avgOrderValueCard: "تێکڕای بەهای داواکاری",
                revenueOverTimeChart: "داهات بەپێی کات",
                salesByProductCategoryChart: "فرۆشراوەکان بەپێی جۆری بەرهەم",
                salesBySellerChart: "فرۆشراوەکان بەپێی فرۆشیار",
                recentActivitiesTitle: "چالاکییە نوێیەکان",
                editProductTitle: "دەستکاریکردنی بەرهەم",
                saveChangesBtn: "پاشەکەوتکردنی گۆڕانکارییەکان",
                cancelBtn: "هەڵوەشاندنەوە",
                qrCodeTitle: "کۆدی QR ی بەرهەم",
                closeBtn: "داخستن",
                setDiscountTitle: "دانانی داشکاندن",
                originalSellPriceLabel: "نرخی فرۆشتنی ڕەسەن",
                discountPercentageLabel: "ڕێژەی داشکاندن (%)",
                discountExpiryDateLabel: "بەرواری بەسەرچوون",
                applyDiscountBtn: "جێبەجێکردنی داشکاندن",
                productNotFound: "بەرهەم نەدۆزرایەوە.",
                insufficientStock: "کۆگا بەشی ناکات.",
                confirmDeleteProduct: "دڵنیایت دەتەوێت ئەم بەرهەمە بسڕیتەوە؟",
                recentActivityAddedProduct: "بەرهەمێکی نوێ زیادکرا",
                recentActivityUpdatedProduct: "بەرهەم نوێکرایەوە",
                recentActivityDeletedProduct: "بەرهەم سڕایەوە",
                recentActivityRecordedSale: "فرۆشراوێکی نوێ تۆمارکرا بۆ",
                userManagementTitle: "بەڕێوەبردنی بەکارهێنەر",
                addNewUserTitle: "زیادکردنی بەکارهێنەری نوێ",
                fullNameLabel: "ناوی تەواو",
                roleLabel: "ڕۆڵ",
                roleSeller: "فرۆشیار",
                roleDataEntry: "داتادێر",
                roleAdmin: "ئەدمن",
                addUserBtn: "زیادکردنی بەکارهێنەر",
                userListTitle: "لیستی بەکارهێنەران",
                tableHeaderUsername: "ناوی بەکارهێنەر",
                tableHeaderFullName: "ناوی تەواو",
                tableHeaderRole: "ڕۆڵ",
                confirmDeleteUser: "دڵنیایت دەتەوێت ئەم بەکارهێنەرە بسڕیتەوە؟",
                userDeleted: "بەکارهێنەر بە سەرکەوتوویی سڕایەوە!",
                userAdded: "بەکارهێنەر بە سەرکەوتوویی زیادکرا!",
                editUserTitle: "دەستکاریکردنی بەکارهێنەر", // New translation
                updateUserBtn: "نوێکردنەوەی بەکارهێنەر", // New translation
                campaignManagementTitle: "بەڕێوەبردنی کامپەین",
                addNewCampaignTitle: "إضافة حملة جديدة",
                campaignNameLabel: "ناوی کامپەین",
                campaignPlatformLabel: "پلاتفۆرم",
                campaignBudgetLabel: "بودجە",
                campaignDurationLabel: "ماوە (ڕۆژ)",
                campaignAudienceLabel: "ئۆدینسی",
                addCampaignBtn: "زیادکردنی کامپەین",
                campaignListTitle: "قائمة الحملات",
                tableHeaderCampaignName: "ناوی کامپەین",
                tableHeaderPlatform: "پلاتفۆرم",
                tableHeaderBudget: "بودجە",
                tableHeaderDuration: "ماوە",
                tableHeaderAudience: "ئۆدینسی",
                confirmDeleteCampaign: "دڵنیایت دەتەوێت ئەم کامپەینە بسڕیتەوە؟",
                reportGenerated: "ڕاپۆرت بە سەرکەوتوویی دروستکرا بە فۆرماتی {format}!",
                selectReportFormat: "فۆرماتی ڕاپۆرت هەڵبژێرە:",
                reportPdfBtn: "دروستکردنی ڕاپۆرتی PDF",
                reportExcelBtn: "دروستکردنی ڕاپۆرتی Excel",
                reportWordBtn: "دروستکردنی ڕاپۆرتی Word",
                productBarcodeExists: "بەرهەمێک بەم بارکۆدە پێشتر هەیە.",
                barcodeScanInstructions: "بارکۆد داخڵبکە بۆ پڕکردنەوەی زانیارییەکانی بەرهەمەکە بە شێوەیەکی خۆکار.",
                tableHeaderTotalPrice: "کۆی نرخ",
                tableHeaderRemainQuantity: "بڕی ماوە",
                totalPriceLabel: "کۆی نرخ",
            }
        };

        let currentLanguage = 'en'; // Default language
        let currentCurrency = 'USD'; // Default currency
        let usdToIqdRate = 1420; // Default conversion rate

        // --- User Role Management ---
        let currentUserRole = null; // Will be set after login
        let currentUserLoggedInName = null; // New: Stores the full name of the logged-in user

        // Using a simple object for user accounts. In a real app, this would be hashed and stored securely.
        let userAccounts = {
            'Admin': { password: 'Admin', role: 'Admin', name: 'John Admin' },
            'Seller': { password: 'Seller', role: 'Seller', name: 'Sarah Seller' },
            'DataEnterer': { password: 'DataEnterer', role: 'DataEnterer', name: 'David Data' }
        };

        // --- Helper Functions ---

        /**
         * Generates a unique ID for new products or sales.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        /**
         * Opens a modal by making its overlay visible.
         * @param {string} modalId - The ID of the modal to open.
         */
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        /**
         * Closes a modal by making its overlay hidden.
         * @param {string} modalId - The ID of the modal to close.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        /**
         * Formats a number into a currency string.
         * Removes trailing .00 if the amount is a whole number.
         * @param {number} amount - The amount in USD to format.
         * @param {boolean} showDualCurrency - If true, returns "USD (IQD)" format.
         * @returns {string} Formatted currency string(s).
         */
        function formatCurrency(amount, showDualCurrency = false) {
            const isWholeNumber = amount % 1 === 0;

            const usdFormatter = new Intl.NumberFormat('en-US', {
                style: 'decimal',
                minimumFractionDigits: isWholeNumber ? 0 : 2,
                maximumFractionDigits: 2
            });
            const iqdFormatter = new Intl.NumberFormat(currentLanguage === 'ar' ? 'ar-IQ' : 'en-US', {
                style: 'decimal',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });

            const formattedUSD = `$${usdFormatter.format(amount)}`;
            const convertedIQD = amount * usdToIqdRate;
            const formattedIQD = `${iqdFormatter.format(convertedIQD)} IQD`;

            if (showDualCurrency) {
                return `${formattedUSD} (${formattedIQD})`;
            } else if (currentCurrency === 'IQD') {
                return formattedIQD;
            } else { // Default to USD
                return formattedUSD;
            }
        }


        /**
         * Translates all elements on the page with a `data-translate-key` attribute
         * to the `currentLanguage`.
         */
        function applyTranslations() {
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            // Update placeholder texts
            document.getElementById('salesSearchInput').placeholder = translations[currentLanguage].searchSalesPlaceholder || 'Search sales by product or customer...';
            document.getElementById('storageSearchInput').placeholder = translations[currentLanguage].searchStoragePlaceholder || 'Search storage items...';
            document.getElementById('productBarcode').placeholder = translations[currentLanguage].barcodeScanInstructions || 'Enter barcode to autofill product details.';
            document.getElementById('saleProductBarcode').placeholder = translations[currentLanguage].barcodeScanInstructions || 'Enter barcode to autofill product details.';


            // Update select options
            document.querySelectorAll('#timePeriodFilter option').forEach(option => {
                const key = option.dataset.translateKey;
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    option.textContent = translations[currentLanguage][key];
                }
            });

            // Adjust document direction for RTL languages
            const body = document.body;
            if (currentLanguage === 'ar' || currentLanguage === 'ku') {
                body.setAttribute('data-lang', currentLanguage);
            } else {
                body.removeAttribute('data-lang');
            }
            // Update current language button text
            const langText = document.getElementById('currentLanguageText');
            if (langText) {
                switch(currentLanguage) {
                    case 'en':
                        langText.textContent = 'English';
                        break;
                    case 'ar':
                        langText.textContent = 'العربية';
                        break;
                    case 'ku':
                        langText.textContent = 'کوردی (سۆرانی)';
                        break;
                }
            }

            // Re-render dynamic content that contains translatable text
            renderProducts();
            renderSales();
            renderStorage();
            renderCampaigns();
            renderUsers(); // To update user roles if they are displayed
            updateDashboardMetrics(); // Ensure currency is correct
            renderCharts(); // Re-render charts to update labels if translated
            renderRecentActivities(); // To update activity descriptions if translated
            renderCurrentSaleTable(); // Re-render current sale table
        }


        /**
         * Toggles the visibility of navigation tabs based on the current user's role.
         */
        function updateTabVisibility() {
            // Define all tabs and their allowed roles
            const tabConfigurations = [
                { id: 'products', roles: ['Admin', 'DataEnterer'] },
                { id: 'sales', roles: ['Admin', 'Seller'] },
                { id: 'storage', roles: ['Admin', 'DataEnterer'] },
                { id: 'dashboard', roles: ['Admin'] },
                { id: 'campaigns', roles: ['Admin'] },
                { id: 'admin', roles: ['Admin'] }
            ];

            // Deactivate all tabs initially
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            let firstAllowedTabName = null;

            tabConfigurations.forEach(tabConfig => {
                const button = document.querySelector(`.tab-button[data-tab="${tabConfig.id}"]`);
                if (!button) return; // Skip if button not found

                if (currentUserRole && tabConfig.roles.includes(currentUserRole)) {
                    button.style.display = ''; // Show the button
                    if (!firstAllowedTabName) {
                        firstAllowedTabName = tabConfig.id; // Set the first allowed tab as the default
                    }
                } else {
                    button.style.display = 'none'; // Hide the button
                }
            });

            // Control visibility and disability of USD to IQD rate input
            const usdToIqdRateInput = document.getElementById('usdToIqdRateInput');
            const usdToIqdRateContainer = document.getElementById('usdToIqdRateContainer');

            usdToIqdRateContainer.classList.remove('hidden'); // Always visible
            if (currentUserRole === 'Admin') {
                usdToIqdRateInput.disabled = false;
            } else {
                usdToIqdRateInput.disabled = true;
            }


            // Activate the first allowed tab
            if (firstAllowedTabName) {
                switchTab(firstAllowedTabName);
            } else {
                console.error('No tabs allowed for this user role. This user should not be logged in.');
                logout(); // Force logout if no tabs are accessible
            }
        }

        /**
         * Switches the active tab in the dashboard.
         * @param {string} tabName - The name of the tab to switch to (e.g., 'products', 'sales', 'dashboard').
         */
        function switchTab(tabName) {
            // Remove active class from all tab buttons and content
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to the selected tab button and content
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}TabContent`).classList.add('active');

            // Re-render specific content when tabs are switched
            if (tabName === 'products') {
                renderProducts();
            } else if (tabName === 'sales') {
                renderSales();
                renderCurrentSaleTable(); // Added to render current sale on tab switch
            } else if (tabName === 'storage') {
                renderStorage();
            } else if (tabName === 'dashboard') {
                updateDashboardMetrics();
                renderCharts();
                renderRecentActivities();
            } else if (tabName === 'admin') {
                renderUsers();
            } else if (tabName === 'campaigns') {
                renderCampaigns();
            }
            // Re-initialize Lucide icons for newly visible content if necessary
            lucide.createIcons();
        }

        /**
         * Calculates the effective sell price of a product, considering discounts and their expiry.
         * @param {object} product - The product object.
         * @returns {number} The calculated sell price (in USD, as that's the base).
         */
        function getEffectiveSellPrice(product) {
            if (product.discount && product.discountExpiry) {
                const expiryDate = new Date(product.discountExpiry);
                const now = new Date();
                if (now < expiryDate) {
                    return product.sellPrice * (1 - product.discount / 100);
                } else {
                    // Discount expired, reset discount for the product
                    product.discount = null;
                    product.discountExpiry = null;
                    // Note: In a real app, this change would be persisted to a backend.
                }
            }
            return product.sellPrice;
        }

        /**
         * Applies the dark mode or light mode to the body.
         * @param {boolean} isDarkMode - True for dark mode, false for light mode.
         */
        function applyMode(isDarkMode) {
            document.body.classList.toggle('dark-mode', isDarkMode);
            const modeToggleBtn = document.getElementById('modeToggle');
            const icon = modeToggleBtn.querySelector('i');
            const text = modeToggleBtn.querySelector('span');

            if (isDarkMode) {
                icon.setAttribute('data-lucide', 'sun');
                text.textContent = translations[currentLanguage].lightModeBtn || 'Light Mode';
            } else {
                icon.setAttribute('data-lucide', 'moon');
                text.textContent = translations[currentLanguage].darkModeBtn || 'Dark Mode';
            }
            lucide.createIcons(); // Refresh icons
            // Re-render charts to update their colors if needed (Chart.js needs to be re-initialized)
            if (document.getElementById('dashboardTabContent').classList.contains('active')) {
                renderCharts();
            }
        }


        // --- Product Management Functions ---

        /**
         * Renders the product list table with current product data.
         */
        function renderProducts() {
            const productListBody = document.getElementById('productList');
            productListBody.innerHTML = ''; // Clear existing rows

            // Filter out deleted products for the main product list
            const activeProducts = products.filter(p => p.status !== 'deleted');

            activeProducts.forEach(product => {
                const row = productListBody.insertRow();
                const currentSellPrice = getEffectiveSellPrice(product);
                const discountDisplay = product.discount ? `${product.discount.toFixed(0)}%` : 'N/A';
                // Display original sell price for comparison if discount exists
                const originalSellPriceDisplay = product.discount ? formatCurrency(product.sellPrice) : '';
                const effectiveSellPriceDualDisplay = formatCurrency(currentSellPrice, true); // Use dual currency display

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-left-ltr">${product.barcode || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.type || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.brand || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right-ltr">${formatCurrency(product.boughtPrice)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right-ltr">
                        ${effectiveSellPriceDualDisplay}
                        ${product.discount ? `<span class="text-xs text-red-500 line-through ml-1">${originalSellPriceDisplay}</span>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${discountDisplay} ${product.discountExpiry ? `<br><span class="text-xs text-gray-500">(${new Date(product.discountExpiry).toLocaleDateString(currentLanguage)})</span>` : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.description || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="openEditProductModal('${product.id}')" class="text-blue-600 hover:text-blue-900 mx-1" data-translate-key="editBtn">Edit</button>
                        <button onclick="setProductDiscount('${product.id}')" class="text-purple-600 hover:text-purple-900 mx-1" data-translate-key="setDiscountBtn">Set Discount</button>
                        <button onclick="showQrCode('${product.id}')" class="text-green-600 hover:text-green-900 mx-1" data-translate-key="showQRBtn">Show QR</button>
                        <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900 mx-1" data-translate-key="deleteBtn">Delete</button>
                    </td>
                `;
                // Apply translations to the buttons within the dynamically created row
                row.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    if (translations[currentLanguage] && translations[currentLanguage][key]) {
                        el.textContent = translations[currentLanguage][key];
                    }
                });
            });
            lucide.createIcons(); // Re-render Lucide icons if any are dynamic
        }

        /**
         * Handles barcode input for adding/editing products.
         * @param {string} barcode - The barcode value entered.
         */
        function handleProductBarcodeInput(barcode) {
            const existingProduct = products.find(p => p.barcode === barcode);
            if (existingProduct) {
                // If product exists, pre-fill fields for editing
                document.getElementById('productName').value = existingProduct.name;
                document.getElementById('productType').value = existingProduct.type;
                document.getElementById('brandName').value = existingProduct.brand;
                document.getElementById('boughtPrice').value = existingProduct.boughtPrice;
                document.getElementById('sellPrice').value = existingProduct.sellPrice;
                document.getElementById('productQuantity').value = existingProduct.quantity;
                document.getElementById('productDescription').value = existingProduct.description;
                // Maybe show a message that this barcode already exists and fields are pre-filled for update
            } else {
                // Clear fields for new product entry if barcode is new
                document.getElementById('productName').value = '';
                document.getElementById('productType').value = '';
                document.getElementById('brandName').value = '';
                document.getElementById('boughtPrice').value = '';
                document.getElementById('sellPrice').value = '';
                document.getElementById('productQuantity').value = '';
                document.getElementById('productDescription').value = '';
            }
        }

        // Add event listener for product barcode input
        document.getElementById('productBarcode').addEventListener('change', function() {
            handleProductBarcodeInput(this.value);
        });


        /**
         * Adds a new product to the `products` array and re-renders the list.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('addProductForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const productBarcode = document.getElementById('productBarcode').value;
            const productName = document.getElementById('productName').value;
            const productType = document.getElementById('productType').value;
            const brandName = document.getElementById('brandName').value;
            const boughtPrice = parseFloat(document.getElementById('boughtPrice').value);
            const sellPrice = parseFloat(document.getElementById('sellPrice').value);
            const productQuantity = parseInt(document.getElementById('productQuantity').value);
            const productDescription = document.getElementById('productDescription').value;

            // Check if barcode already exists for a non-deleted product
            const existingProduct = products.find(p => p.barcode === productBarcode && p.status !== 'deleted');
            if (existingProduct) {
                alert(translations[currentLanguage].productBarcodeExists || "Product with this barcode already exists.");
                return;
            }

            const newProduct = {
                id: generateUniqueId(),
                barcode: productBarcode,
                name: productName,
                type: productType,
                brand: brandName,
                boughtPrice: boughtPrice,
                sellPrice: sellPrice,
                quantity: productQuantity,
                description: productDescription,
                status: productQuantity > 0 ? 'available' : 'not-available', // Initial status based on quantity
                discount: null,
                discountExpiry: null
            };

            products.push(newProduct); // Add the new product
            renderProducts(); // Re-render the product list
            renderStorage(); // Re-render storage to show new item
            document.getElementById('addProductForm').reset(); // Clear the form
            // Add activity log
            dashboardData.recentActivities.unshift({
                id: generateUniqueId(),
                description: `${translations[currentLanguage].recentActivityAddedProduct || 'Added new product'}: ${productName} (Barcode: ${productBarcode}).`,
                date: new Date().toLocaleDateString(currentLanguage)
            });
            renderRecentActivities();
        });

        /**
         * Opens the edit product modal and populates it with product data.
         * @param {string} productId - The ID of the product to edit.
         */
        function openEditProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductBarcode').value = product.barcode;
                document.getElementById('editProductName').value = product.name;
                document.getElementById('editProductType').value = product.type;
                document.getElementById('editBrandName').value = product.brand;
                document.getElementById('editBoughtPrice').value = product.boughtPrice;
                document.getElementById('editSellPrice').value = product.sellPrice;
                document.getElementById('editProductQuantity').value = product.quantity;
                document.getElementById('editProductDescription').value = product.description;
                openModal('editProductModal');
            }
        }

        /**
         * Handles the submission of the edit product form, updates product data, and re-renders.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('editProductForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const productId = document.getElementById('editProductId').value;
            const updatedBarcode = document.getElementById('editProductBarcode').value;
            const updatedName = document.getElementById('editProductName').value;
            const updatedType = document.getElementById('editProductType').value;
            const updatedBrand = document.getElementById('editBrandName').value;
            const updatedBoughtPrice = parseFloat(document.getElementById('editBoughtPrice').value);
            const updatedSellPrice = parseFloat(document.getElementById('editSellPrice').value);
            const updatedQuantity = parseInt(document.getElementById('editProductQuantity').value);
            const updatedDescription = document.getElementById('editProductDescription').value;

            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                // Check if the new barcode already exists for another product
                const existingProductWithBarcode = products.find(p => p.barcode === updatedBarcode && p.id !== productId && p.status !== 'deleted');
                if (existingProductWithBarcode) {
                    alert(translations[currentLanguage].productBarcodeExists || "Product with this barcode already exists.");
                    return;
                }

                products[productIndex] = {
                    ...products[productIndex],
                    barcode: updatedBarcode,
                    name: updatedName,
                    type: updatedType,
                    brand: updatedBrand,
                    boughtPrice: updatedBoughtPrice,
                    sellPrice: updatedSellPrice,
                    quantity: updatedQuantity,
                    description: updatedDescription
                };
                // Update status if quantity becomes 0 or greater than 0
                if (products[productIndex].status !== 'deleted') { // Don't change status if it's explicitly deleted
                     products[productIndex].status = updatedQuantity > 0 ? 'available' : 'not-available';
                }

                renderProducts();
                renderStorage();
                closeModal('editProductModal');
                // Add activity log
                dashboardData.recentActivities.unshift({
                    id: generateUniqueId(),
                    description: `${translations[currentLanguage].recentActivityUpdatedProduct || 'Updated product'}: ${updatedName} (Barcode: ${updatedBarcode}).`,
                    date: new Date().toLocaleDateString(currentLanguage)
                });
                renderRecentActivities();
            }
        });

        /**
         * Opens the discount modal and populates it.
         * @param {string} productId - The ID of the product for discount.
         */
        function setProductDiscount(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                document.getElementById('discountProductId').value = product.id;
                document.getElementById('discountOriginalPrice').value = formatCurrency(product.sellPrice); // Original price is base sellPrice
                document.getElementById('discountPercentage').value = product.discount || '';

                // Initialize flatpickr for the expiry date
                flatpickr("#discountExpiryDate", {
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    defaultDate: product.discountExpiry ? product.discountExpiry : null
                });

                openModal('discountModal');
            }
        }

        /**
         * Handles the submission of the discount form.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('discountForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const productId = document.getElementById('discountProductId').value;
            const discountPercentage = parseFloat(document.getElementById('discountPercentage').value);
            const expiryDate = document.getElementById('discountExpiryDate').value;

            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                if (isNaN(discountPercentage) || discountPercentage < 0 || discountPercentage > 100) {
                    alert("Please enter a valid discount percentage between 0 and 100.");
                    return;
                }
                products[productIndex].discount = discountPercentage;
                products[productIndex].discountExpiry = expiryDate ? new Date(expiryDate) : null;
                renderProducts(); // Re-render to show discount
                closeModal('discountModal');
                // Add activity log
                dashboardData.recentActivities.unshift({
                    id: generateUniqueId(),
                    description: `Discount set for ${products[productIndex].name}: ${discountPercentage}% until ${expiryDate || 'no expiry'}.`,
                    date: new Date().toLocaleDateString(currentLanguage)
                });
                renderRecentActivities();
            }
        });


        /**
         * Marks a product as 'deleted' and re-renders the list and storage.
         * @param {string} productId - The ID of the product to delete.
         */
        function deleteProduct(productId) {
            if (confirm(translations[currentLanguage].confirmDeleteProduct || "Are you sure you want to delete this product?")) {
                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    const deletedProductName = products[productIndex].name;
                    products[productIndex].status = 'deleted';
                    products[productIndex].quantity = 0; // Set quantity to 0 when deleted
                    renderProducts(); // Will filter out deleted products
                    renderStorage(); // Will show it as deleted
                    // Add activity log
                    dashboardData.recentActivities.unshift({
                        id: generateUniqueId(),
                        description: `${translations[currentLanguage].recentActivityDeletedProduct || 'Deleted product'}: ${deletedProductName}.`,
                        date: new Date().toLocaleDateString(currentLanguage)
                    });
                    renderRecentActivities();
                }
            }
        }

        /**
         * Shows a simulated QR code for a product. In a real app, this would use a QR code library.
         * @param {string} productId - The ID of the product for which to show the QR code.
         */
        function showQrCode(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                // Ensure the QR content is unique per product and includes relevant details
                const qrContent = `Product ID: ${product.id}\nBarcode: ${product.barcode || 'N/A'}\nName: ${product.name}\nType: ${product.type || 'N/A'}\nBrand: ${product.brand || 'N/A'}\nSell Price: ${formatCurrency(getEffectiveSellPrice(product))}\nQuantity: ${product.quantity}\nDescription: ${product.description || 'N/A'}`;
                document.getElementById('qrCodeDisplayArea').textContent = qrContent;
                openModal('qrCodeModal');
            }
        }

        // --- Sales Management Functions ---

        /**
         * Renders the sales list table with current sales data, applying filters from search bar.
         */
        function renderSales() {
            const salesListBody = document.getElementById('salesList');
            salesListBody.innerHTML = ''; // Clear existing rows
            const searchTerm = document.getElementById('salesSearchInput').value.toLowerCase();

            const filteredSales = sales.filter(sale =>
                sale.productName.toLowerCase().includes(searchTerm) ||
                sale.customerName.toLowerCase().includes(searchTerm) ||
                (sale.sellerName && sale.sellerName.toLowerCase().includes(searchTerm)) // Search by seller name
            );

            filteredSales.forEach(sale => {
                const row = salesListBody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.productName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right-ltr">${formatCurrency(sale.finalSellPrice)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.customerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-left-ltr">${new Date(sale.date).toLocaleDateString(currentLanguage)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.sellerName || 'N/A'}</td> <!-- Display seller name -->
                `;
            });
        }

        /**
         * Renders the dynamic table for the current sale, including total price.
         */
        function renderCurrentSaleTable() {
            const currentSaleTableBody = document.getElementById('currentSaleTableBody');
            currentSaleTableBody.innerHTML = '';
            let totalSalePrice = 0;

            currentSaleItems.forEach((item, index) => {
                const productInStock = products.find(p => p.id === item.productId);
                const remainingQuantity = productInStock ? productInStock.quantity : 0;
                const itemTotalPrice = item.quantity * item.effectiveSellPrice;
                totalSalePrice += itemTotalPrice;

                const row = currentSaleTableBody.insertRow();
                row.innerHTML = `
                    <td class="px-2 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 text-left-ltr">${item.barcode || 'N/A'}</td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500">${item.productName}</td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 text-right-ltr">${formatCurrency(item.effectiveSellPrice, true)}</td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500">
                        <input type="number" value="${item.quantity}" min="1" max="${remainingQuantity + item.quantity}" class="w-16 px-1 py-0.5 border border-gray-300 rounded-md text-sm text-center" onchange="updateCurrentSaleItemQuantity('${item.productId}', this.value)">
                    </td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 text-right-ltr">${formatCurrency(itemTotalPrice, true)}</td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500">${remainingQuantity}</td>
                    <td class="px-2 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="removeCurrentSaleItem('${item.productId}')" class="text-red-600 hover:text-red-900 mx-1">
                             <i data-lucide="trash-2" class="h-5 w-5"></i>
                        </button>
                    </td>
                `;
            });

            document.getElementById('currentSaleTotalPrice').value = formatCurrency(totalSalePrice, true);
            lucide.createIcons(); // Re-render Lucide icons for new list items
        }

        /**
         * Updates the quantity of an item in the current sale table.
         * @param {string} productId - The ID of the product.
         * @param {string} newQuantityStr - The new quantity as a string.
         */
        function updateCurrentSaleItemQuantity(productId, newQuantityStr) {
            let newQuantity = parseInt(newQuantityStr);
            if (isNaN(newQuantity) || newQuantity < 1) {
                // Revert to previous valid quantity if input is invalid
                const item = currentSaleItems.find(item => item.productId === productId);
                if (item) {
                    newQuantity = item.quantity;
                    event.target.value = newQuantity; // Set the input field back to the current value
                } else {
                    newQuantity = 1; // Fallback if item somehow not found
                }
                alert("Please enter a valid quantity (a number greater than 0).");
            }

            const itemIndex = currentSaleItems.findIndex(item => item.productId === productId);
            if (itemIndex !== -1) {
                const productInStock = products.find(p => p.id === productId);
                // Calculate total quantity of this product currently in `currentSaleItems`
                const currentTotalInSale = currentSaleItems
                    .filter(item => item.productId === productId)
                    .reduce((sum, item) => sum + item.quantity, 0);

                // The quantity available for *this specific item in the sale*
                // is its previous quantity + the actual remaining stock in `products`
                const previousItemQuantity = currentSaleItems[itemIndex].quantity;
                const availableForThisItem = productInStock.quantity + previousItemQuantity;

                if (newQuantity > availableForThisItem) {
                    alert(translations[currentLanguage].insufficientStock || "Insufficient stock.");
                    newQuantity = availableForThisItem; // Cap at available stock
                    event.target.value = newQuantity; // Update the input field
                }

                currentSaleItems[itemIndex].quantity = newQuantity;
                renderCurrentSaleTable(); // Re-render to update total and remaining quantity
            }
        }


        /**
         * Removes an item from the current sale table.
         * @param {string} productId - The ID of the product to remove.
         */
        function removeCurrentSaleItem(productId) {
            currentSaleItems = currentSaleItems.filter(item => item.productId !== productId);
            renderCurrentSaleTable();
        }

        /**
         * Adds a product to the current sale items.
         * This function is now used by both barcode and autocomplete.
         * @param {object} product - The product object to add.
         */
        function addProductToCurrentSale(product) {
            const existingItemInSale = currentSaleItems.find(item => item.productId === product.id);

            // Calculate current total quantity of this product in the currentSaleItems array
            const currentQuantityInSale = currentSaleItems
                .filter(item => item.productId === product.id)
                .reduce((sum, item) => sum + item.quantity, 0);

            // Calculate truly available stock for *new* additions (stock - what's already in sale)
            const actualAvailableStock = product.quantity - currentQuantityInSale;

            if (existingItemInSale) {
                if (actualAvailableStock > 0) {
                    existingItemInSale.quantity++;
                    renderCurrentSaleTable();
                } else {
                    alert(translations[currentLanguage].insufficientStock || "Insufficient stock.");
                }
            } else {
                if (product.quantity > 0) { // Check if there's any initial stock
                    currentSaleItems.push({
                        productId: product.id,
                        barcode: product.barcode,
                        productName: product.name,
                        effectiveSellPrice: getEffectiveSellPrice(product),
                        quantity: 1 // Add with quantity 1
                    });
                    renderCurrentSaleTable();
                } else {
                    alert(translations[currentLanguage].insufficientStock || "Insufficient stock.");
                }
            }
            document.getElementById('saleProductBarcode').value = ''; // Clear input after processing
            document.getElementById('saleProductName').value = ''; // Clear associated product name input
            closeAllLists(); // Close autocomplete suggestions
        }


        /**
         * Handles barcode input for sales.
         * @param {string} barcode - The barcode value entered.
         */
        function handleSaleBarcodeInput(barcode) {
            const product = products.find(p => p.barcode === barcode && p.status !== 'deleted');
            if (product) {
                addProductToCurrentSale(product);
            } else {
                alert(translations[currentLanguage].productNotFound || "Product not found or out of stock for this barcode.");
                document.getElementById('saleProductBarcode').value = '';
                document.getElementById('saleProductName').value = '';
            }
        }

        // Add event listener for sales barcode input
        document.getElementById('saleProductBarcode').addEventListener('change', function() {
            handleSaleBarcodeInput(this.value);
        });


        /**
         * Autocomplete functionality for product names in the sales form.
         * This now ADDS to the current sale table directly upon selection/enter.
         */
        let currentFocus;
        document.getElementById('saleProductName').addEventListener('input', function(e) {
            const val = this.value;
            closeAllLists();
            if (!val) {
                return false;
            }
            currentFocus = -1;
            const a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);

            products.filter(p => p.status !== 'deleted' && p.name.toLowerCase().includes(val.toLowerCase())).forEach(p => {
                const b = document.createElement("DIV");
                b.innerHTML = "<strong>" + p.name.substr(0, val.length) + "</strong>";
                b.innerHTML += p.name.substr(val.length);
                b.innerHTML += `<input type='hidden' value='${p.id}'>`; // Store product ID
                b.addEventListener("click", function(e) {
                    const selectedProductId = this.getElementsByTagName("input")[0].value;
                    const selectedProduct = products.find(prod => prod.id === selectedProductId);
                    if (selectedProduct) {
                       addProductToCurrentSale(selectedProduct);
                    }
                    document.getElementById('saleProductName').value = ''; // Clear after adding
                    document.getElementById('saleProductBarcode').value = '';
                    closeAllLists();
                });
                a.appendChild(b);
            });
        });

        document.getElementById('saleProductName').addEventListener('keydown', function(e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) { // Arrow Down
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) { // Arrow Up
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) { // Enter key
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click(); // Simulate a click on the active item
                } else {
                    // If no item is highlighted, and Enter is pressed,
                    // try to find an exact match for the typed name and add it
                    const typedProductName = this.value.trim().toLowerCase();
                    const exactMatchProduct = products.find(p => p.name.toLowerCase() === typedProductName && p.status !== 'deleted');
                    if (exactMatchProduct) {
                        addProductToCurrentSale(exactMatchProduct);
                    } else {
                        alert(translations[currentLanguage].productNotFound || "Product not found.");
                    }
                    document.getElementById('saleProductName').value = ''; // Clear input
                    closeAllLists();
                }
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        function closeAllLists(elmnt) {
            const x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != document.getElementById('saleProductName')) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });

        /**
         * Records the entire current sale.
         */
        document.getElementById('recordSaleButton').addEventListener('click', function() {
            if (currentSaleItems.length === 0) {
                alert('Please add items to the sale before recording.');
                return;
            }

            // A prompt for customer name, as it's not in the new layout but is in original sales data structure
            const customerName = prompt(translations[currentLanguage].customerNameLabel || 'Enter Customer Name:');
            if (!customerName) {
                alert('Customer name is required to record the sale.');
                return;
            }

            currentSaleItems.forEach(item => {
                const productInStock = products.find(p => p.id === item.productId);
                if (productInStock && productInStock.quantity >= item.quantity) {
                    productInStock.quantity -= item.quantity;
                    if (productInStock.quantity === 0) {
                        productInStock.status = 'not-available';
                    }

                    const newSale = {
                        id: generateUniqueId(),
                        productId: item.productId,
                        productName: item.productName,
                        productType: productInStock.type, // Get from actual product data
                        brandName: productInStock.brand,   // Get from actual product data
                        quantity: item.quantity,
                        originalSellPrice: productInStock.sellPrice,
                        finalSellPrice: item.quantity * item.effectiveSellPrice,
                        customerName: customerName,
                        date: new Date().toISOString().slice(0, 10),
                        sellerName: currentUserLoggedInName // New: Add the name of the logged-in user
                    };
                    sales.push(newSale);
                    dashboardData.recentActivities.unshift({
                        id: generateUniqueId(),
                        description: `${translations[currentLanguage].recentActivityRecordedSale || 'Recorded new sale for'} ${item.productName} (ID: ${newSale.id}).`,
                        date: new Date().toLocaleDateString(currentLanguage)
                    });

                } else {
                    alert(`Error: Not enough stock for ${item.productName}. Sale not fully processed.`);
                }
            });

            currentSaleItems = []; // Clear the current sale
            renderCurrentSaleTable();
            renderSales();
            renderProducts();
            renderStorage();
            updateDashboardMetrics();
            renderCharts();
            renderRecentActivities();
            alert('Sale recorded successfully!');
        });


        // --- Storage Section Functions ---
        function renderStorage() {
            const storageListBody = document.getElementById('storageList');
            storageListBody.innerHTML = '';
            const searchTerm = document.getElementById('storageSearchInput').value.toLowerCase();

            const filteredProducts = products.filter(p =>
                p.name.toLowerCase().includes(searchTerm) ||
                p.barcode.toLowerCase().includes(searchTerm) ||
                (translations[currentLanguage][`status${p.status.charAt(0).toUpperCase() + p.status.slice(1)}`] || p.status).toLowerCase().includes(searchTerm)
            );

            filteredProducts.forEach(product => {
                const row = storageListBody.insertRow();
                let statusText = translations[currentLanguage][`status${product.status.charAt(0).toUpperCase() + product.status.slice(1)}`] || product.status;
                let statusClass = '';
                if (product.status === 'available') {
                    statusClass = 'text-green-600';
                } else if (product.status === 'not-available') {
                    statusClass = 'text-yellow-600';
                } else if (product.status === 'deleted') {
                    statusClass = 'text-red-600';
                }
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-left-ltr">${product.barcode || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${statusClass}">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-left-ltr">${new Date().toLocaleDateString(currentLanguage)}</td>
                `; // Using current date for simplicity, a real app would store last update
            });
        }
        // Event listener for storage search input
        document.getElementById('storageSearchInput').addEventListener('input', renderStorage);


        // --- Dashboard & Reporting Functions ---

        // Chart instances
        let revenueChartInstance, salesByTypeChartInstance, salesBySellerChartInstance; // Added salesBySellerChartInstance

        /**
         * Updates the key performance indicator (KPI) metrics on the dashboard.
         */
        function updateDashboardMetrics() {
            const timePeriod = document.getElementById('timePeriodFilter').value;
            const now = new Date();
            let relevantSales = [];

            if (timePeriod === 'day') {
                const today = now.toISOString().slice(0, 10);
                relevantSales = sales.filter(sale => sale.date === today);
            } else if (timePeriod === 'week') {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(now.getDate() - 7);
                relevantSales = sales.filter(sale => new Date(sale.date) >= oneWeekAgo);
            } else { // month
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);
                relevantSales = sales.filter(sale => sale.date >= startOfMonth);
            }

            // Calculate Total Revenue
            dashboardData.totalRevenue = relevantSales.reduce((sum, sale) => sum + sale.finalSellPrice, 0);

            // Calculate Total Profit
            dashboardData.totalProfit = relevantSales.reduce((sum, sale) => {
                const product = products.find(p => p.id === sale.productId);
                if (product) {
                    // Profit for a sale item: (finalSellPrice per item - boughtPrice per item) * quantity
                    // sale.finalSellPrice is total for the quantity, so (sale.finalSellPrice / sale.quantity) is price per item
                    return sum + ((sale.finalSellPrice / sale.quantity) - product.boughtPrice) * sale.quantity;
                }
                return sum;
            }, 0);

            // Calculate Total Items Sold
            dashboardData.totalItemsSold = relevantSales.reduce((sum, sale) => sum + sale.quantity, 0);

            // Calculate Average Order Value
            if (relevantSales.length > 0) {
                // Avg order value should be based on number of distinct sales transactions, not total items
                // For simplicity here, we'll calculate based on the current filtered sales
                dashboardData.avgOrderValue = dashboardData.totalRevenue / relevantSales.length;
            } else {
                dashboardData.avgOrderValue = 0;
            }

            document.getElementById('totalRevenue').textContent = formatCurrency(dashboardData.totalRevenue);
            document.getElementById('totalProfit').textContent = formatCurrency(dashboardData.totalProfit);
            document.getElementById('totalItemsSold').textContent = dashboardData.totalItemsSold;
            document.getElementById('avgOrderValue').textContent = formatCurrency(dashboardData.avgOrderValue);
        }

        /**
         * Renders (or re-renders) the Chart.js graphs on the dashboard.
         */
        function renderCharts() {
            // Destroy existing chart instances before creating new ones to prevent duplicates
            if (revenueChartInstance) revenueChartInstance.destroy();
            if (salesByTypeChartInstance) salesByTypeChartInstance.destroy();
            if (salesBySellerChartInstance) salesBySellerChartInstance.destroy(); // New: Destroy seller chart

            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false, // Allows flexible sizing based on container
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) { // For line chart (revenue) or bar chart (seller)
                                    label += formatCurrency(context.parsed.y);
                                } else if (context.parsed !== null) { // For doughnut chart (sales by type)
                                    label += formatCurrency(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#666'
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                        }
                    },
                    y: {
                        ticks: {
                            color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#666',
                            callback: function(value, index, values) {
                                return formatCurrency(value); // Format Y-axis labels as currency
                            }
                        },
                        grid: {
                            color: document.body.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                        }
                    }
                }
            };

            // Calculate dynamic revenue data for the chart based on the selected time period
            const timePeriod = document.getElementById('timePeriodFilter').value;
            const now = new Date();
            let revenueLabels = [];
            let revenueData = [];

            if (timePeriod === 'day') {
                for (let i = 6; i >= 0; i--) { // Last 7 days
                    const d = new Date();
                    d.setDate(now.getDate() - i);
                    const dateStr = d.toISOString().slice(0, 10);
                    revenueLabels.push(d.toLocaleDateString(currentLanguage, { weekday: 'short', day: 'numeric' }));
                    const salesForDay = sales.filter(s => s.date === dateStr);
                    const dailyRevenue = salesForDay.reduce((sum, s) => sum + s.finalSellPrice, 0);
                    revenueData.push(dailyRevenue);
                }
            } else if (timePeriod === 'week') {
                // Group sales by week (simplified for last ~4 weeks)
                const weeksData = {};
                for (let i = 0; i < 4; i++) {
                    const d = new Date();
                    d.setDate(now.getDate() - (i * 7));
                    // Get the start of the week (e.g., Monday) for consistent grouping
                    const startOfWeek = new Date(d.setDate(d.getDate() - (d.getDay() + 6) % 7)); // Monday start
                    const weekIdentifier = `${startOfWeek.getFullYear()}-${startOfWeek.getMonth() + 1}-${startOfWeek.getDate()}`; //YYYY-MM-DD for start of week
                    weeksData[weekIdentifier] = 0; // Initialize
                }

                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    const saleWeekStart = new Date(saleDate.setDate(saleDate.getDate() - (saleDate.getDay() + 6) % 7));
                    const weekIdentifier = `${saleWeekStart.getFullYear()}-${saleWeekStart.getMonth() + 1}-${saleWeekStart.getDate()}`;
                    if (weeksData.hasOwnProperty(weekIdentifier)) {
                        weeksData[weekIdentifier] += sale.finalSellPrice;
                    }
                });

                revenueLabels = Object.keys(weeksData).sort((a, b) => new Date(a) - new Date(b));
                revenueData = revenueLabels.map(label => weeksData[label]);

                // Adjust labels for week, e.g., "Week X"
                revenueLabels = revenueLabels.map(label => `Wk ${new Date(label).toLocaleDateString(currentLanguage, {month: 'short', day: 'numeric'})}`);


            } else { // month
                // Default to last 6 months
                const monthsData = {};
                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(now.getMonth() - i);
                    const monthName = d.toLocaleDateString(currentLanguage, { month: 'short', year: 'numeric' });
                    monthsData[monthName] = 0; // Initialize
                }

                sales.forEach(sale => {
                    const saleDate = new Date(sale.date);
                    const monthName = saleDate.toLocaleDateString(currentLanguage, { month: 'short', year: 'numeric' });
                    if (monthsData.hasOwnProperty(monthName)) {
                        monthsData[monthName] += sale.finalSellPrice;
                    }
                });
                revenueLabels = Object.keys(monthsData);
                revenueData = Object.values(monthsData);
            }

            dashboardData.revenueOverTime.labels = revenueLabels;
            dashboardData.revenueOverTime.data = revenueData;


            // Sales by Product Type Chart Data
            const salesByTypeMap = {};
            sales.forEach(sale => {
                const type = sale.productType || 'Unknown';
                salesByTypeMap[type] = (salesByTypeMap[type] || 0) + sale.finalSellPrice;
            });
            dashboardData.salesByProductType.labels = Object.keys(salesByTypeMap);
            dashboardData.salesByProductType.data = Object.values(salesByTypeMap);

            // New: Sales by Seller Chart Data
            const salesBySellerMap = {};
            sales.forEach(sale => {
                const seller = sale.sellerName || 'Unknown Seller';
                salesBySellerMap[seller] = (salesBySellerMap[seller] || 0) + sale.finalSellPrice;
            });
            dashboardData.salesBySeller.labels = Object.keys(salesBySellerMap);
            dashboardData.salesBySeller.data = Object.values(salesBySellerMap);


            // Revenue Over Time Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChartInstance = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: dashboardData.revenueOverTime.labels,
                    datasets: [{
                        label: translations[currentLanguage].revenueOverTimeChart || 'Revenue',
                        data: dashboardData.revenueOverTime.data,
                        borderColor: document.body.classList.contains('dark-mode') ? '#63B3ED' : '#3B82F6', // blue-300 / blue-500
                        backgroundColor: document.body.classList.contains('dark-mode') ? 'rgba(99, 179, 237, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: commonChartOptions
            });

            // Sales by Product Type Chart (Doughnut)
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            salesByTypeChartInstance = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: dashboardData.salesByProductType.labels,
                    datasets: [{
                        label: translations[currentLanguage].salesByProductCategoryChart || 'Sales by Product Type',
                        data: dashboardData.salesByProductType.data,
                        backgroundColor: [
                            '#F59E0B', // yellow-500
                            '#10B981', // green-500
                            '#EF4444', // red-500
                            '#6366F1', // indigo-500
                            '#EC4899', // pink-500
                            '#14B8A6'  // teal-500
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // New: Sales by Seller Chart (Bar)
            const salesBySellerCtx = document.getElementById('salesBySellerChart').getContext('2d');
            salesBySellerChartInstance = new Chart(salesBySellerCtx, {
                type: 'bar',
                data: {
                    labels: dashboardData.salesBySeller.labels,
                    datasets: [{
                        label: translations[currentLanguage].salesBySellerChart || 'Sales by Seller',
                        data: dashboardData.salesBySeller.data,
                        backgroundColor: document.body.classList.contains('dark-mode') ? '#a78bfa' : '#8B5CF6', // purple-300 / purple-500
                        borderColor: document.body.classList.contains('dark-mode') ? '#8b5cf6' : '#6b21a8', // purple-500 / purple-900
                        borderWidth: 1
                    }]
                },
                options: {
                    ...commonChartOptions, // Use common options for consistency
                    scales: {
                        x: {
                            ...commonChartOptions.scales.x, // Inherit x-axis styles
                            grid: {
                                display: false // No grid lines for bar chart x-axis
                            }
                        },
                        y: {
                            ...commonChartOptions.scales.y, // Inherit y-axis styles
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        /**
         * Renders the list of recent activities.
         */
        function renderRecentActivities() {
            const activitiesList = document.getElementById('recentActivitiesList');
            activitiesList.innerHTML = '';
            // Display only a limited number of recent activities
            const activitiesToShow = dashboardData.recentActivities.slice(0, 10);
            activitiesToShow.forEach(activity => {
                const li = document.createElement('li');
                li.className = 'flex items-center text-gray-700 dark:text-gray-300';
                li.innerHTML = `
                    <span class="mr-2 text-gray-400 ${currentLanguage === 'ar' || currentLanguage === 'ku' ? 'ml-2 mr-0' : ''}">
                        <i data-lucide="check-circle" class="h-5 w-5"></i>
                    </span>
                    <span>${activity.description} <span class="text-xs text-gray-500">(${activity.date})</span></span>
                `;
                activitiesList.appendChild(li);
            });
            lucide.createIcons(); // Re-render Lucide icons for new list items
        }

        /**
         * Opens the report generation modal.
         */
        function openReportModal() {
            openModal('reportModal');
        }

        /**
         * Generates a report in a selected format.
         * @param {string} format - The desired report format (pdf, excel, word).
         */
        async function generateReport(format) {
            let filename = `Business_Report_${new Date().toISOString().slice(0, 10)}`;

            // Collect dashboard metrics
            const metrics = {
                'Total Revenue': document.getElementById('totalRevenue').textContent,
                'Total Profit': document.getElementById('totalProfit').textContent,
                'Total Items Sold': document.getElementById('totalItemsSold').textContent,
                'Avg. Order Value': document.getElementById('avgOrderValue').textContent,
            };

            // Collect recent activities
            const recentActivities = dashboardData.recentActivities.map(act => `${act.description} (${act.date})`);

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Set font for multi-language support (requires font embedding for non-Latin characters)
                // For a real-world app, you would need to embed a font like 'Amiri' for Arabic
                // doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
                // doc.setFont('Amiri');

                let y = 10;
                const margin = 10;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const isRTL = currentLanguage === 'ar' || currentLanguage === 'ku';

                // Helper for text alignment
                const alignText = (text, x, y, options = {}) => {
                    if (isRTL) {
                        doc.text(text, pageWidth - x, y, { align: 'right', ...options });
                    } else {
                        doc.text(text, x, y, { align: 'left', ...options });
                    }
                };

                doc.setFontSize(18);
                alignText(translations[currentLanguage].marketingDashboardTitle, margin, y);
                y += 10;
                doc.setFontSize(10);
                alignText(`${translations[currentLanguage].reportGenerated.split('{format}')[0]} ${new Date().toLocaleString(currentLanguage)}`, margin, y);
                y += 20;

                // Key Metrics
                doc.setFontSize(14);
                alignText(translations[currentLanguage].dashboardOverviewTitle, margin, y);
                y += 10;
                doc.setFontSize(10);
                for (const [key, value] of Object.entries(metrics)) {
                    alignText(`${key}: ${value}`, margin + 5, y);
                    y += 7;
                }
                y += 10;

                // Sales History Table
                doc.setFontSize(14);
                alignText(translations[currentLanguage].salesHistoryTitle, margin, y);
                y += 10;

                const salesHeaders = [
                    translations[currentLanguage].tableHeaderSaleId,
                    translations[currentLanguage].tableHeaderSaleProductName,
                    translations[currentLanguage].tableHeaderSaleQuantity,
                    translations[currentLanguage].tableHeaderSalePrice,
                    translations[currentLanguage].tableHeaderCustomerName,
                    translations[currentLanguage].tableHeaderSaleDate,
                    translations[currentLanguage].tableHeaderSoldBy
                ];
                const salesData = sales.map(s => [
                    s.id,
                    s.productName,
                    s.quantity,
                    formatCurrency(s.finalSellPrice, true), // Dual currency in report
                    s.customerName,
                    new Date(s.date).toLocaleDateString(currentLanguage),
                    s.sellerName || 'N/A'
                ]);

                doc.autoTable({
                    head: [salesHeaders],
                    body: salesData,
                    startY: y,
                    margin: { horizontal: margin },
                    styles: {
                        font: 'helvetica', // Default font, for RTL support use a font like 'Amiri'
                        fontSize: 8,
                        cellPadding: 2,
                        overflow: 'linebreak',
                        halign: isRTL ? 'right' : 'left'
                    },
                    headStyles: {
                        fillColor: '#EBF8FF', // blue-50
                        textColor: '#3B82F6', // blue-500
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        3: { halign: 'right', cellWidth: 35, direction: 'ltr' }, // Price column, force LTR numbers
                        5: { halign: 'left', cellWidth: 20, direction: 'ltr' }, // Date column, force LTR
                        0: { halign: 'left', direction: 'ltr' }, // ID column, force LTR
                        2: { halign: 'left', direction: 'ltr' } // Quantity column, force LTR
                    },
                    didDrawPage: (data) => {
                        y = data.cursor.y + 10; // Update Y position after table
                        if (y > pageHeight - margin) {
                            doc.addPage();
                            y = margin;
                        }
                    }
                });
                y = doc.autoTable.previous.finalY + 10; // Get the final Y position after the table

                // Product List Table
                doc.setFontSize(14);
                alignText(translations[currentLanguage].productListTitle, margin, y);
                y += 10;

                const productHeaders = [
                    translations[currentLanguage].tableHeaderId,
                    translations[currentLanguage].tableHeaderBarcode,
                    translations[currentLanguage].tableHeaderProductName,
                    translations[currentLanguage].tableHeaderProductType,
                    translations[currentLanguage].tableHeaderBrandName,
                    translations[currentLanguage].tableHeaderBoughtPrice,
                    translations[currentLanguage].tableHeaderSellPrice,
                    translations[currentLanguage].tableHeaderQuantity,
                    translations[currentLanguage].tableHeaderDiscount,
                    translations[currentLanguage].tableHeaderDescription
                ];
                const productsData = products.map(p => [
                    p.id,
                    p.barcode || 'N/A',
                    p.name,
                    p.type || 'N/A',
                    p.brand || 'N/A',
                    formatCurrency(p.boughtPrice),
                    formatCurrency(getEffectiveSellPrice(p), true), // Dual currency in report
                    p.quantity,
                    p.discount ? `${p.discount}%` : 'N/A',
                    p.description || 'N/A'
                ]);

                doc.autoTable({
                    head: [productHeaders],
                    body: productsData,
                    startY: y,
                    margin: { horizontal: margin },
                    styles: {
                        font: 'helvetica',
                        fontSize: 8,
                        cellPadding: 2,
                        overflow: 'linebreak',
                        halign: isRTL ? 'right' : 'left'
                    },
                    headStyles: {
                        fillColor: '#EBF8FF',
                        textColor: '#3B82F6',
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { halign: 'left', direction: 'ltr' }, // ID, force LTR
                        1: { halign: 'left', direction: 'ltr' }, // Barcode, force LTR
                        5: { halign: 'right', direction: 'ltr' }, // Bought Price, force LTR numbers
                        6: { halign: 'right', direction: 'ltr' }, // Sell Price, force LTR numbers
                        7: { halign: 'left', direction: 'ltr' }  // Quantity, force LTR
                    },
                    didDrawPage: (data) => {
                        y = data.cursor.y + 10; // Update Y position after table
                        if (y > pageHeight - margin) {
                            doc.addPage();
                            y = margin;
                        }
                    }
                });
                y = doc.autoTable.previous.finalY + 10;

                // Recent Activities
                doc.setFontSize(14);
                alignText(translations[currentLanguage].recentActivitiesTitle, margin, y);
                y += 10;
                doc.setFontSize(10);
                recentActivities.forEach(activity => {
                    if (y > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                    }
                    alignText(`• ${activity}`, margin + 5, y);
                    y += 7;
                });

                doc.save(`${filename}.pdf`);
            } else if (format === 'excel') {
                const wb = XLSX.utils.book_new();

                // Metrics Sheet
                const metricsData = [
                    [translations[currentLanguage].tableHeaderMetric || 'Metric', translations[currentLanguage].tableHeaderValue || 'Value']
                ];
                for (const [key, value] of Object.entries(metrics)) {
                    metricsData.push([key, value]);
                }
                const ws_metrics = XLSX.utils.aoa_to_sheet(metricsData);
                XLSX.utils.book_append_sheet(wb, ws_metrics, translations[currentLanguage].dashboardOverviewTitle || 'Dashboard Metrics');

                // Sales History Sheet
                const salesHeaders = [
                    translations[currentLanguage].tableHeaderSaleId,
                    translations[currentLanguage].tableHeaderSaleProductName,
                    translations[currentLanguage].tableHeaderSaleQuantity,
                    `${translations[currentLanguage].tableHeaderSalePrice} (USD)`, // Raw USD
                    `${translations[currentLanguage].tableHeaderSalePrice} (IQD)`, // Raw IQD
                    `${translations[currentLanguage].tableHeaderSalePrice} (Formatted)`, // Formatted dual currency
                    translations[currentLanguage].tableHeaderCustomerName,
                    translations[currentLanguage].tableHeaderSaleDate,
                    translations[currentLanguage].tableHeaderSoldBy
                ];
                const salesData = sales.map(s => [
                    s.id,
                    s.productName,
                    s.quantity,
                    s.finalSellPrice, // Raw USD
                    s.finalSellPrice * usdToIqdRate, // Raw IQD
                    formatCurrency(s.finalSellPrice, true), // Formatted dual currency
                    s.customerName,
                    new Date(s.date).toLocaleDateString(currentLanguage),
                    s.sellerName || 'N/A'
                ]);
                const ws_sales = XLSX.utils.aoa_to_sheet([salesHeaders, ...salesData]);
                XLSX.utils.book_append_sheet(wb, ws_sales, translations[currentLanguage].salesHistoryTitle || 'Sales History');

                // Products List Sheet
                const productHeaders = [
                    translations[currentLanguage].tableHeaderId,
                    translations[currentLanguage].tableHeaderBarcode,
                    translations[currentLanguage].tableHeaderProductName,
                    translations[currentLanguage].tableHeaderProductType,
                    translations[currentLanguage].tableHeaderBrandName,
                    `${translations[currentLanguage].tableHeaderBoughtPrice} (USD)`, // Raw USD
                    `${translations[currentLanguage].tableHeaderBoughtPrice} (IQD)`, // Raw IQD
                    `${translations[currentLanguage].tableHeaderSellPrice} (USD)`, // Raw USD
                    `${translations[currentLanguage].tableHeaderSellPrice} (IQD)`, // Raw IQD
                    `${translations[currentLanguage].tableHeaderSellPrice} (Formatted)`, // Formatted dual currency
                    translations[currentLanguage].tableHeaderQuantity,
                    translations[currentLanguage].tableHeaderDiscount,
                    translations[currentLanguage].tableHeaderDescription
                ];
                const productsData = products.map(p => [
                    p.id,
                    p.barcode || 'N/A',
                    p.name,
                    p.type || 'N/A',
                    p.brand || 'N/A',
                    p.boughtPrice, // Raw USD
                    p.boughtPrice * usdToIqdRate, // Raw IQD
                    getEffectiveSellPrice(p), // Raw USD (effective price)
                    getEffectiveSellPrice(p) * usdToIqdRate, // Raw IQD (effective price)
                    formatCurrency(getEffectiveSellPrice(p), true), // Formatted dual currency
                    p.quantity,
                    p.discount ? `${p.discount}%` : 'N/A',
                    p.description || 'N/A'
                ]);
                const ws_products = XLSX.utils.aoa_to_sheet([productHeaders, ...productsData]);
                XLSX.utils.book_append_sheet(wb, ws_products, translations[currentLanguage].productListTitle || 'Product List');

                // Recent Activities Sheet (New)
                const activityHeaders = [
                    translations[currentLanguage].tableHeaderDate || 'Date',
                    translations[currentLanguage].tableHeaderActivity || 'Activity'
                ];
                const activitiesData = dashboardData.recentActivities.map(act => [
                    act.date,
                    act.description
                ]);
                const ws_activities = XLSX.utils.aoa_to_sheet([activityHeaders, ...activitiesData]);
                XLSX.utils.book_append_sheet(wb, ws_activities, translations[currentLanguage].recentActivitiesTitle || 'Recent Activities');


                XLSX.writeFile(wb, `${filename}.xlsx`);
            } else if (format === 'word') {
                let htmlContent = `
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: sans-serif; direction: ${currentLanguage === 'ar' || currentLanguage === 'ku' ? 'rtl' : 'ltr'}; text-align: ${currentLanguage === 'ar' || currentLanguage === 'ku' ? 'right' : 'left'}; }
                            h1 { color: #3B82F6; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: ${currentLanguage === 'ar' || currentLanguage === 'ku' ? 'right' : 'left'}; }
                            th { background-color: #f2f2f2; }
                            /* Force LTR for specific columns in Word */
                            .ltr-data { direction: ltr; text-align: left; }
                            .ltr-price { direction: ltr; text-align: right; }
                        </style>
                    </head>
                    <body>
                        <h1>Business Management Dashboard Report</h1>
                        <p>Generated on: ${new Date().toLocaleString(currentLanguage)}</p>

                        <h2>Key Metrics:</h2>
                        <ul>
                `;
                for (const [key, value] of Object.entries(metrics)) {
                    htmlContent += `<li><strong>${key}:</strong> ${value}</li>`;
                }
                htmlContent += `
                        </ul>

                        <h2>Recent Activities:</h2>
                        <ul>
                `;
                recentActivities.forEach(activity => {
                    htmlContent += `<li>${activity}</li>`;
                });
                htmlContent += `
                        </ul>

                        <h2>Sales History:</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>${translations[currentLanguage].tableHeaderSaleId}</th>
                                    <th>${translations[currentLanguage].tableHeaderSaleProductName}</th>
                                    <th>${translations[currentLanguage].tableHeaderSaleQuantity}</th>
                                    <th>${translations[currentLanguage].tableHeaderSalePrice}</th>
                                    <th>${translations[currentLanguage].tableHeaderCustomerName}</th>
                                    <th>${translations[currentLanguage].tableHeaderSaleDate}</th>
                                    <th>${translations[currentLanguage].tableHeaderSoldBy}</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                sales.forEach(s => {
                    htmlContent += `
                                <tr>
                                    <td class="ltr-data">${s.id}</td>
                                    <td>${s.productName}</td>
                                    <td class="ltr-data">${s.quantity}</td>
                                    <td class="ltr-price">${formatCurrency(s.finalSellPrice, true)}</td>
                                    <td>${s.customerName}</td>
                                    <td class="ltr-data">${new Date(s.date).toLocaleDateString(currentLanguage)}</td>
                                    <td>${s.sellerName || 'N/A'}</td>
                                </tr>
                    `;
                });
                htmlContent += `
                            </tbody>
                        </table>

                        <h2>Product List:</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>${translations[currentLanguage].tableHeaderId}</th>
                                    <th>${translations[currentLanguage].tableHeaderBarcode}</th>
                                    <th>${translations[currentLanguage].tableHeaderProductName}</th>
                                    <th>${translations[currentLanguage].tableHeaderProductType}</th>
                                    <th>${translations[currentLanguage].tableHeaderBrandName}</th>
                                    <th>${translations[currentLanguage].tableHeaderBoughtPrice}</th>
                                    <th>${translations[currentLanguage].tableHeaderSellPrice}</th>
                                    <th>${translations[currentLanguage].tableHeaderQuantity}</th>
                                    <th>${translations[currentLanguage].tableHeaderDiscount}</th>
                                    <th>${translations[currentLanguage].tableHeaderDescription}</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                products.forEach(p => {
                    htmlContent += `
                                <tr>
                                    <td class="ltr-data">${p.id}</td>
                                    <td class="ltr-data">${p.barcode || 'N/A'}</td>
                                    <td>${p.name}</td>
                                    <td>${p.type || 'N/A'}</td>
                                    <td>${p.brand || 'N/A'}</td>
                                    <td class="ltr-price">${formatCurrency(p.boughtPrice)}</td>
                                    <td class="ltr-price">${formatCurrency(getEffectiveSellPrice(p), true)}</td>
                                    <td class="ltr-data">${p.quantity}</td>
                                    <td>${p.discount ? `${p.discount}%` : 'N/A'}</td>
                                    <td>${p.description || 'N/A'}</td>
                                </tr>
                    `;
                });
                htmlContent += `
                            </tbody>
                        </table>

                    </body>
                    </html>
                `;

                const blob = new Blob([htmlContent], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.doc`; // Save as .doc which is compatible with Word from HTML
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            alert(translations[currentLanguage].reportGenerated.replace('{format}', format) || `Report generated successfully in ${format} format!`);
            closeModal('reportModal');
        }


        // --- Campaign Management Functions ---
        function renderCampaigns() {
            const campaignListBody = document.getElementById('campaignList');
            campaignListBody.innerHTML = '';

            campaigns.forEach(campaign => {
                const row = campaignListBody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${campaign.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${campaign.platform}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right-ltr">${formatCurrency(campaign.budget)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${campaign.duration} ${translations[currentLanguage].dayOption.toLowerCase()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${campaign.audience}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editCampaign('${campaign.id}')" class="text-blue-600 hover:text-blue-900 mx-1" data-translate-key="editBtn">Edit</button>
                        <button onclick="deleteCampaign('${campaign.id}')" class="text-red-600 hover:text-red-900 mx-1" data-translate-key="deleteBtn">Delete</button>
                    </td>
                `;
                row.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    if (translations[currentLanguage] && translations[currentLanguage][key]) {
                        el.textContent = translations[currentLanguage][key];
                    }
                });
            });
            lucide.createIcons();
        }

        document.getElementById('addCampaignForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const name = document.getElementById('campaignName').value;
            const platform = document.getElementById('campaignPlatform').value;
            const budget = parseFloat(document.getElementById('campaignBudget').value);
            const duration = parseInt(document.getElementById('campaignDuration').value);
            const audience = document.getElementById('campaignAudience').value;

            const newCampaign = {
                id: generateUniqueId(),
                name,
                platform,
                budget,
                duration,
                audience
            };
            campaigns.push(newCampaign);
            renderCampaigns();
            document.getElementById('addCampaignForm').reset();
            dashboardData.recentActivities.unshift({
                id: generateUniqueId(),
                description: `Added new campaign: ${name}.`,
                date: new Date().toLocaleDateString(currentLanguage)
            });
            renderRecentActivities();
        });

        function editCampaign(campaignId) {
            alert('Edit Campaign functionality not yet implemented for this demo.'); // Placeholder
        }

        function deleteCampaign(campaignId) {
            if (confirm(translations[currentLanguage].confirmDeleteCampaign || "Are you sure you want to delete this campaign?")) {
                const deletedCampaignName = campaigns.find(c => c.id === campaignId)?.name;
                campaigns = campaigns.filter(c => c.id !== campaignId);
                renderCampaigns();
                dashboardData.recentActivities.unshift({
                    id: generateUniqueId(),
                    description: `Deleted campaign: ${deletedCampaignName}.`,
                    date: new Date().toLocaleDateString(currentLanguage)
                });
                renderRecentActivities();
            }
        }


        // --- Admin/User Management Functions ---
        function renderUsers() {
            const userListBody = document.getElementById('userList');
            userListBody.innerHTML = '';

            for (const username in userAccounts) {
                const user = userAccounts[username];
                const row = userListBody.insertRow();
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.name || 'N/A'}</td> <!-- Display Full Name -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" data-translate-key="role${user.role}">${translations[currentLanguage][`role${user.role}`] || user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${username !== 'Admin' ? `
                            <button onclick="openEditUserModal('${username}')" class="text-blue-600 hover:text-blue-900 mx-1" data-translate-key="editBtn">Edit</button>
                            <button onclick="deleteUser('${username}')" class="text-red-600 hover:text-red-900 mx-1" data-translate-key="deleteBtn">Delete</button>
                        ` : ''}
                    </td>
                `;
                row.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    if (translations[currentLanguage] && translations[currentLanguage][key]) {
                        el.textContent = translations[currentLanguage][key];
                    }
                });
            }
            lucide.createIcons(); // Ensure icons are rendered for new buttons
        }

        /**
         * Opens the edit user modal and populates it with user data.
         * @param {string} username - The username of the user to edit.
         */
        function openEditUserModal(username) {
            const user = userAccounts[username];
            if (user) {
                document.getElementById('originalUsername').value = username; // Store original username for update
                document.getElementById('editUsername').value = username;
                document.getElementById('editUserFullName').value = user.name;
                // Do not populate password for security, leave blank to keep current
                document.getElementById('editUserPassword').value = '';
                document.getElementById('editUserRole').value = user.role;
                openModal('editUserModal');
            }
        }

        /**
         * Handles the submission of the edit user form, updates user data, and re-renders.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('editUserForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const originalUsername = document.getElementById('originalUsername').value;
            const newUsername = document.getElementById('editUsername').value;
            const newUserFullName = document.getElementById('editUserFullName').value;
            const newUserPassword = document.getElementById('editUserPassword').value;
            const newUserRole = document.getElementById('editUserRole').value;

            // Check if new username already exists and is different from original
            if (newUsername !== originalUsername && userAccounts[newUsername]) {
                alert('New username already exists!');
                return;
            }

            const user = userAccounts[originalUsername];
            if (user) {
                // Delete old entry if username changed
                if (newUsername !== originalUsername) {
                    delete userAccounts[originalUsername];
                }

                // Update or create new entry
                userAccounts[newUsername] = {
                    name: newUserFullName,
                    role: newUserRole,
                    password: newUserPassword ? newUserPassword : user.password // Keep old password if new one is blank
                };

                // If the currently logged-in user's data was changed, update display
                if (currentUserLoggedInName && originalUsername === currentUserLoggedInName) {
                    currentUserLoggedInName = newUserFullName;
                    document.getElementById('loggedInUserName').textContent = currentUserLoggedInName;
                    currentUserRole = newUserRole; // Also update current user's role in session
                } else if (currentUserRole && userAccounts[originalUsername] && userAccounts[originalUsername].name === currentUserLoggedInName) {
                     // Handle case where user is logged in as 'Admin' and is editing 'Seller'
                     // Re-evaluate user role for tab visibility if current role changed.
                     if (userAccounts[newUsername].role !== currentUserRole) {
                         // This is a complex scenario to handle dynamically without a full re-login flow.
                         // For simplicity, we'll just re-render and inform.
                         alert(`Note: The role of ${newUserFullName} was changed. If this was the logged in user, a re-login might be required for tab permissions to fully update.`);
                     }
                }


                renderUsers();
                closeModal('editUserModal');
                alert(translations[currentLanguage].userAdded || 'User updated successfully!'); // Reuse message
                // Add activity log
                dashboardData.recentActivities.unshift({
                    id: generateUniqueId(),
                    description: `Updated user: ${newUserFullName} (${newUsername}, ${newUserRole}).`,
                    date: new Date().toLocaleDateString(currentLanguage)
                });
                renderRecentActivities();
            }
        });


        document.getElementById('addUserForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const newUsername = document.getElementById('newUsername').value;
            const newUserFullName = document.getElementById('newUserFullName').value; // Get the new full name
            const newUserPassword = document.getElementById('newUserPassword').value;
            const newUserRole = document.getElementById('newUserRole').value;

            if (userAccounts[newUsername]) {
                alert('Username already exists!');
                return;
            }

            userAccounts[newUsername] = { password: newUserPassword, role: newUserRole, name: newUserFullName }; // Store the new full name
            renderUsers();
            document.getElementById('addUserForm').reset();
            alert(translations[currentLanguage].userAdded || 'User added successfully!');
            // Add activity log
            dashboardData.recentActivities.unshift({
                id: generateUniqueId(),
                description: `Added new user: ${newUserFullName} (${newUsername}, ${newUserRole}).`,
                date: new Date().toLocaleDateString(currentLanguage)
            });
            renderRecentActivities();
        });

        function deleteUser(username) {
            if (confirm(translations[currentLanguage].confirmDeleteUser || `Are you sure you want to delete user "${username}"?`)) {
                if (username === 'Admin') {
                    alert('Cannot delete the default Admin user.');
                    return;
                }
                const deletedUserName = userAccounts[username]?.name;
                delete userAccounts[username];
                renderUsers();
                alert(translations[currentLanguage].userDeleted || 'User deleted successfully!');
                // Add activity log
                dashboardData.recentActivities.unshift({
                    id: generateUniqueId(),
                    description: `Deleted user: ${deletedUserName || username}.`,
                    date: new Date().toLocaleDateString(currentLanguage)
                });
                renderRecentActivities();
            }
        }


        // --- Event Listeners and Initializers ---

        /**
         * Handles the login form submission.
         * @param {Event} event - The form submission event.
         */
        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            if (userAccounts[username] && userAccounts[username].password === password) {
                currentUserRole = userAccounts[username].role;
                currentUserLoggedInName = userAccounts[username].name; // Set logged-in user's full name
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardContainer').classList.remove('hidden');
                document.getElementById('loggedInUserDisplay').classList.remove('hidden');
                document.getElementById('loggedInUserName').textContent = currentUserLoggedInName; // Display the name
                applyTranslations(); // Apply translations after login based on default language
                updateTabVisibility(); // Show/hide tabs based on role and hide/show exchange rate input
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // Event listener for tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                switchTab(tabName);
            });
        });

        // Language selection dropdown toggle
        document.getElementById('languageToggleButton').addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent click from bubbling to document and closing immediately
            const dropdown = document.getElementById('languageDropdown');
            dropdown.classList.toggle('hidden');
        });

        // Language option click handler
        document.querySelectorAll('.lang-option').forEach(button => {
            button.addEventListener('click', function() {
                currentLanguage = this.dataset.lang;
                applyTranslations();
                document.getElementById('languageDropdown').classList.add('hidden'); // Hide dropdown after selection
            });
        });

        // Currency selection dropdown toggle
        document.getElementById('currencyToggleButton').addEventListener('click', function(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('currencyDropdown');
            dropdown.classList.toggle('hidden');
        });

        // Currency option click handler
        document.querySelectorAll('.currency-option').forEach(button => {
            button.addEventListener('click', function() {
                currentCurrency = this.dataset.currency;
                document.getElementById('currentCurrencyText').textContent = currentCurrency;
                applyTranslations(); // Re-render to update currency displays
                document.getElementById('currencyDropdown').classList.add('hidden');
            });
        });

        // Event listener for USD to IQD conversion rate input
        document.getElementById('usdToIqdRateInput').addEventListener('input', function(event) {
            const newRate = parseFloat(event.target.value);
            if (!isNaN(newRate) && newRate > 0) {
                usdToIqdRate = newRate;
                // Re-render relevant sections to reflect new conversion rate immediately
                renderProducts();
                renderSales();
                updateDashboardMetrics();
                renderCharts();
                renderCurrentSaleTable(); // Also update current sale table prices
            }
        });


        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const languageToggleBtn = document.getElementById('languageToggleButton');
            const languageDropdown = document.getElementById('languageDropdown');
            const currencyToggleBtn = document.getElementById('currencyToggleButton');
            const currencyDropdown = document.getElementById('currencyDropdown');
            const usdToIqdRateContainer = document.getElementById('usdToIqdRateContainer'); // Added to check for clicks

            if (!languageToggleBtn.contains(event.target) && !languageDropdown.contains(event.target)) {
                languageDropdown.classList.add('hidden');
            }
            // Only hide currency dropdown if click is outside both button, dropdown and the rate input container
            if (!currencyToggleBtn.contains(event.target) && !currencyDropdown.contains(event.target) && !usdToIqdRateContainer.contains(event.target)) {
                currencyDropdown.classList.add('hidden');
            }
        });

        // Dark/Light Mode Toggle
        document.getElementById('modeToggle').addEventListener('click', function() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            applyMode(!isDarkMode);
        });

        // Dashboard refresh button
        document.getElementById('refreshDashboardBtn').addEventListener('click', function() {
            updateDashboardMetrics();
            renderCharts();
            renderRecentActivities();
        });

        // Report Generation Button
        document.getElementById('generateReportBtn').addEventListener('click', openReportModal);

        // Time period filter for dashboard metrics
        document.getElementById('timePeriodFilter').addEventListener('change', function() {
            updateDashboardMetrics();
            renderCharts();
        });

        // Logout button
        document.getElementById('logoutButton').addEventListener('click', logout);

        function logout() {
            currentUserRole = null;
            currentUserLoggedInName = null; // Clear logged-in user name
            document.getElementById('dashboardContainer').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset(); // Clear login form
            document.getElementById('loginError').classList.add('hidden'); // Hide error
            document.getElementById('loggedInUserDisplay').classList.add('hidden'); // Hide logged-in user display
            document.getElementById('loggedInUserName').textContent = ''; // Clear the name display
            // Reset to default language and mode on logout if desired
            currentLanguage = 'en';
            currentCurrency = 'USD';
            document.getElementById('currentCurrencyText').textContent = 'USD'; // Ensure display is updated
            usdToIqdRate = 1420; // Reset conversion rate
            document.getElementById('usdToIqdRateInput').value = 1420; // Update input field
            applyTranslations(); // Reapply default translations
            applyMode(false); // Reset to light mode
            currentSaleItems = []; // Clear current sale items on logout
            updateTabVisibility(); // Re-evaluate tab visibility and USD to IQD rate input visibility after logout
        }

        // Initial render calls when the page loads (after a successful login, these will be called again)
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Initial setup for default language and currency display
            document.getElementById('currentLanguageText').textContent = 'English';
            document.getElementById('currentCurrencyText').textContent = 'USD';
            document.getElementById('usdToIqdRateInput').value = usdToIqdRate; // Set initial rate value
            renderCurrentSaleTable(); // Initial render of the new sales table
            // Set initial visibility of USD to IQD rate container based on initial (null) role.
            // This will ensure it's hidden before login.
            updateTabVisibility(); // Call this to set initial disabled state for the rate input
        });

    </script>
</body>
</html>
